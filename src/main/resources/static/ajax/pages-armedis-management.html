<div class="page-content">
    <div class="container-fluid">
    <!-- start page title -->
    <div class="row">
      <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
              <h4 class="mb-sm-0">Redis Config Í¥ÄÎ¶¨Ïûê</h4>

              <div class="page-title-right">
                  <ol class="breadcrumb m-0">
                      <li class="breadcrumb-item"><a href="javascript: void(0);">Armedis</a></li>
                      <li class="breadcrumb-item active">Management</li>
                  </ol>
              </div>
          </div>
      </div>
    </div>
    <!-- end page title -->

    <div class="row">
        <ul class="nav nav-tabs mb-3" id="categoryTabs"></ul>
	
        <!-- Í≤ÄÏÉâÏ∞Ω -->
        <div class="input-group mb-3">
            <span class="input-group-text">üîç</span>
            <input type="text" id="searchInput" class="form-control" placeholder="ÌÇ§ÏõåÎìú Í≤ÄÏÉâ">
            <button id="resetBtn" class="btn btn-outline-secondary">Ï¥àÍ∏∞Ìôî</button>
        </div>
	
        <!-- ÏÑ§Ï†ï ÌÖåÏù¥Î∏î -->
        <table class="table table-striped" id="configTable">
            <thead>
                <tr>
                    <th>ÏÑ§Ï†ï ÌÇ§</th>
                    <th>ÌòÑÏû¨Í∞í</th>
                    <th>ÏÑ§Î™Ö</th>
                    <th>Ìé∏Ïßë</th>
	            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <!-- Ìé∏Ïßë Î™®Îã¨ -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
        <!--      <div class="modal-dialog">-->
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>ÌòÑÏû¨Í∞í: <span id="modalCurrent">-</span></p>
                        <div id="modalInputContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                        <button type="button" id="saveBtn" class="btn btn-primary">Ï†ÄÏû•</button>
	                </div>
                </div>
            </div>
        </div> 
        <!-- Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
        <!--      <div class="modal-dialog">-->
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loginModalTitle">Login</h5>
                    </div>
                    <div class="modal-body">
                        <div id="modalInputContainer">
                            <input id="loginModalInputId" type="text" class="form-control" value="admin" placeholder="ID">
                            <input id="loginModalInputPassword" type="password" class="form-control" value="ezwel1234" placeholder="PASSWORD">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="saveLoginBtn" class="btn btn-primary w-100">Î°úÍ∑∏Ïù∏</button>
	                </div>
                </div>
            </div>
        </div> 
    </div>
    <!-- container-fluid -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
        <div id="liveToast" class="toast hide toast-center" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">ÏïåÎ¶º</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>
</div>
<!-- End Page-content -->  

<script src="/assets/js/common.js"></script>

<style>
	.current-value { font-weight: bold; }
</style>
<!-- Î°úÏª¨ JS Ï∞∏Ï°∞ -->
<!-- <script src="/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script> -->

<script>
	// ÏÑ§Ï†ï Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
	var configKeys = [
	//{ key:'maxmemory',            category:'Memory',      description:'ÏµúÎåÄ Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ (Î∞îÏù¥Ìä∏)',           dataType:'number' },
	//{ key:'maxmemory-policy',     category:'Memory',      description:'Î©îÎ™®Î¶¨ Ï¥àÍ≥º Ïãú ÌÇ§ ÏÇ≠Ï†ú Ï†ïÏ±Ö',           dataType:'dropdown', options:['noeviction','allkeys-lru','volatile-lru','volatile-random'] },
	//{ key:'maxclients',           category:'Client',      description:'ÎèôÏãú Ï†ëÏÜç Í∞ÄÎä•Ìïú ÏµúÎåÄ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïàò',    dataType:'number' },
	//{ key:'timeout',              category:'Client',      description:'Ïú†Ìú¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Í≤∞ Ï¢ÖÎ£å ÏãúÍ∞Ñ(Ï¥à)',     dataType:'number' },
	//{ key:'save',                 category:'Persistence', description:'RDB Ïä§ÎÉÖÏÉ∑ Ï£ºÍ∏∞',                      dataType:'text' },
	//{ key:'appendonly',           category:'Persistence', description:'AOF ÏÇ¨Ïö© Ïó¨Î∂Ä',                        dataType:'toggle' },
	//{ key:'appendfsync',          category:'Persistence', description:'AOF ÎèôÍ∏∞Ìôî Ï†ïÏ±Ö',                      dataType:'dropdown', options:['always','everysec','no'] },
	//{ key:'tcp-keepalive',        category:'Network',     description:'TCP keepalive ÏãúÍ∞Ñ(Ï¥à)',               dataType:'number' },
	//{ key:'bind',                 category:'Network',     description:'Î∞îÏù∏ÎìúÌï† IP Î¶¨Ïä§Ìä∏',                    dataType:'text' },
	//{ key:'requirepass',          category:'Security',    description:'ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïù∏Ï¶ù ÎπÑÎ∞ÄÎ≤àÌò∏',              dataType:'password' },
	//{ key:'rename-command',       category:'Security',    description:'Î™ÖÎ†πÏñ¥ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω',                      dataType:'keyvalue' },
	//{ key:'loglevel',             category:'Logging',     description:'Î°úÍ∑∏ Î†àÎ≤®',                            dataType:'dropdown', options:['debug','verbose','notice','warning'] },
	//{ key:'logfile',              category:'Logging',     description:'Î°úÍ∑∏ ÌååÏùº Í≤ΩÎ°ú',                       dataType:'text' },
	//{ key:'cluster-enabled',      category:'Cluster',     description:'ÌÅ¥Îü¨Ïä§ÌÑ∞ Î™®Îìú ÏÇ¨Ïö© Ïó¨Î∂Ä',               dataType:'toggle' },
	//{ key:'cluster-node-timeout', category:'Cluster',     description:'ÌÅ¥Îü¨Ïä§ÌÑ∞ ÎÖ∏Îìú ÌÉÄÏûÑÏïÑÏõÉ(Î∞ÄÎ¶¨Ï¥à)',         dataType:'number' }
	];

	var tableBody = document.querySelector("#configTable tbody");
	var editModal  = new bootstrap.Modal(document.getElementById("editModal"));
    var loginModal = new bootstrap.Modal(document.getElementById("loginModal"), {
        backdrop: 'static' // Î∞îÍπ• ÌÅ¥Î¶≠Ìï¥ÎèÑ Îã´ÌûàÏßÄ ÏïäÏùå
    });
    var currentEdit = null;
	var kvMap = {};
	var editEventObject = null; //ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Í∞ùÏ≤¥

	// ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ
	function renderTable(category="All", filter="") {
        tableBody.innerHTML = "";
        configKeys.filter(i => (category==="All" || i.category===category) && (i.key.includes(filter) || i.description.includes(filter)))
	               .forEach(i => {
                  var tr = document.createElement("tr");
                  tr.innerHTML = `
                    <td>${i.key}</td>
                    <td><span class="current-value" data-key="${i.key}">${i.currentValue ?? "-"}</span></td>
                    <td>${i.description}</td>
                    <td><button class="btn btn-sm btn-outline-primary edit-btn" data-key="${i.key}" data-cat="${i.category}">‚úèÔ∏è</button></td>
                    `;
                  tableBody.appendChild(tr);
                });
       document.querySelectorAll(".edit-btn").forEach(btn => btn.addEventListener("click", openModal));
    }


    // Î™®Îã¨ Ïó¥Í∏∞
    function openModal(e) {
        // Î°úÍ∑∏Ïù∏ Î™®Îã¨ Ïó¥Í∏∞
        editEventObject = e.currentTarget.dataset;
        loginModal.show();
	}

    // Î™®Îã¨ Ïó¥Í∏∞
    function openEditModal(e) {
        var itemsList = []; 
        var key = e.key;
        var cat = e.cat;
        currentEdit = configKeys.find(i => i.key === key);
        document.getElementById("modalTitle").textContent = `${key} ÏÑ§Ï†ï Î≥ÄÍ≤Ω`;
        document.getElementById("modalCurrent").textContent = "Î∂àÎü¨Ïò§Îäî Ï§ë...";
        kvMap = {};
        renderModalInput(currentEdit, "");
        editModal.show();
//       // Ï°∞Ìöå
        fetch("/v1/management/settings/config/" + key)
            .then(res=> {
                if (!res.ok) {
                    editModal.hide();
                    throw new Error('Ï°∞Ìöå Ïã§Ìå® : ' + res.statusText);
                }
                return res.json();
            })
            .then(data=> {
                var currentKey = Object.keys(data.result)[0];
                var currentVal = data.result[currentKey];
                var viewCurrentVal = data.result[currentKey];
                if (!isNaN(viewCurrentVal)) {
                    viewCurrentVal = numberWithCommas(currentVal);
                }
                document.getElementById("modalCurrent").textContent = viewCurrentVal;
                if (currentEdit.dataType === "keyvalue") 
                try { 
                    kvMap = JSON.parse(currentVal);
                } catch {
                    document.getElementById("modalCurrent").textContent = "-";
                };
                renderModalInput(currentEdit, currentVal);
            })
            .catch(err=> {
                alert('Ï°∞Ìöå Ïã§Ìå®' + err);
            	document.getElementById("modalCurrent").textContent = "-";
                editModal.hide();
            });
	}
// ÏûÖÎ†• Ïª¥Ìè¨ÎÑåÌä∏ ÏÉùÏÑ±
	function renderModalInput(cfg, curr) {
        var cont = document.getElementById("modalInputContainer");
	    cont.innerHTML = "";
        var html = "";
        switch(cfg.dataType) {
            case "number":
                html = `<input id="modalInput" type="number" class="form-control" value="${curr}">`;
                break;
            case "dropdown":
                html = `<select id="modalInput" class="form-select">${cfg.options.map(o=>`<option value="${o}"${o===curr?' selected':''}>${o}</option>`).join('')}</select>`;
                break;
            case "toggle":
                html = `<div class="form-check form-switch"><input id="modalInput" class="form-check-input" type="checkbox"${curr==='yes'?' checked':''}><label class="form-check-label">${cfg.description}</label></div>`;
                break;
            case "password":
                html = `<input id="modalInput" type="password" class="form-control" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏">`;
                break;
            case "text":
                html = `<textarea id="modalInput" class="form-control" rows="3">${curr}</textarea>`;
                break;
            case "keyvalue":
                html = `<div id="kvContainer" class="mb-2"></div><button id="addKvBtn" class="btn btn-sm btn-outline-secondary mb-3">+ Ï∂îÍ∞Ä</button>`;
                break;
        }
        cont.innerHTML = html;
        if (cfg.dataType === "keyvalue") initKeyValue();
    }

	// keyvalue Ï¥àÍ∏∞Ìôî Î∞è Î†åÎçî
    function initKeyValue() {
        var kvCont = document.getElementById("kvContainer")
        var addBtn = document.getElementById("addKvBtn");
        addBtn.onclick = () => { 
            kvMap[""] = ""; renderKV();
        };

        function renderKV() {
            kvCont.innerHTML = "";
            Object.entries(kvMap).forEach(([k,v]) => {
                var row = document.createElement("div");
                row.className = "d-flex mb-2";
                row.innerHTML = `<input class="form-control me-2" data-key="key" value="${k}" placeholder="Î™ÖÎ†πÏñ¥">` +
                                `<input class="form-control me-2" data-key="value" value="${v}" placeholder="ÏÉà Ïù¥Î¶Ñ">` +
                                `<button class="btn btn-sm btn-danger">-</button>`;
                row.querySelector("button").onclick=()=>{
                    delete kvMap[k];
                    renderKV();
                };
                row.querySelectorAll("input").forEach(inp=>{
                    inp.oninput=()=>{
                        const newKey=row.querySelector("[data-key=key]").value;
                        const newVal=row.querySelector("[data-key=value]").value;
                        delete kvMap[k]; if(newKey) kvMap[newKey]=newVal; renderKV();
                    };
                });
                kvCont.appendChild(row);
            });
        }
        renderKV();
    }

    // Ï†ÄÏû• Ï≤òÎ¶¨
    document.getElementById("saveBtn").onclick=()=>{
        var val;
        if (currentEdit.dataType === "toggle") val = document.getElementById("modalInput").checked ? "yes":"no";
        else if (currentEdit.dataType === "keyvalue") val = JSON.stringify(kvMap);
        else val = document.getElementById("modalInput").value;
        
        if (value === "" || value === null || value === undefined) {
            alert("Í∞íÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
            return;
        }
        
        if (currentEdit.dataType === "number") {
            if (isNaN(val)) {
                alert("Ïà´ÏûêÌòïÏù¥ ÏïÑÎãôÎãàÎã§. Îã§Ïãú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
                return;
            }
        }

        //TODO: login api ÎÇòÏò§Î©¥ Î≥ÄÍ≤Ω
        $.ajax({
            url: '../assets/json/login-verify.json',
            method: "GET",
            beforeSend: function(xhr) {
                var token = sessionStorage.getItem("auth-token");
                if (token) xhr.setRequestHeader("auth-token", token);
            },
            success: function(data) {
                if (data.result) {
                    //Ï†ÄÏû•
                    var formData = new URLSearchParams();
                    formData.append("value", val);
                    fetch("/v1/management/settings/config/" + currentEdit.key, {
                        method:"PUT",
                        headers:{"Content-Type":"application/x-www-form-urlencoded"},
                        body: formData.toString()
                        })
                        .then(res=> {
                        })
                        .then(data => { 
                            document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent = val;
                            editModal.hide();
                        })
                        .catch(err=> {
                            alert("Ï†ÄÏû• Ïã§Ìå®: " + err)
                        });
                } else {
                    alert("Î°úÍ∑∏Ïù∏ Í≤ÄÏ¶ù Ïã§Ìå®");
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        })


        //var formData = new URLSearchParams();
        //formData.append("value", val);
        //
        //// Ï†ÄÏû•
        //fetch("/v1/management/settings/config/" + currentEdit.key, {
        //    method:"PUT",
        //    headers:{"Content-Type":"application/x-www-form-urlencoded"},
        //    body: formData.toString()
        //    })
        //    .then(res=> {
        //    })
        //    .then(data => { 
        //        document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent = val;
        //        editModal.hide();
        //    })
        //    .catch(err=> {
        //    	alert("Ï†ÄÏû• Ïã§Ìå®: " + err)
        //    });
	};//

    // Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨
    document.getElementById("saveLoginBtn").onclick=()=>{
        var id = document.getElementById("loginModalInputId").value;
        var pwd = document.getElementById("loginModalInputPassword").value;
        
        if (id != 'admin' || pwd != 'ezwel1234') {
            alert("Í∞íÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§");
            return;
        }

        // TODO: Î°úÍ∑∏Ïù∏ api ÎÇòÏò§Î©¥ Î≥ÄÍ≤Ω
        $.ajax({
            url: '../assets/json/login.json',
            method: "GET",
            dataType: "json",
            success: function(data) {
                if (data.result) {
                    sessionStorage.setItem("auth-token", data.token);
                    loginModal.hide();
                    openEditModal(editEventObject);
                    editEventObject = null; // Ïû¨ÏÇ¨Ïö© Î∞©ÏßÄ
                } else {
                    alert("Î°úÍ∑∏Ïù∏ Ïù∏Ï¶ùÏù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§");
                    return;
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        })


        // Ï†ÄÏû•
        //var formData = new URLSearchParams();
        //formData.append("value", val);
        //fetch("/v1/management/settings/config/" + currentEdit.key, {
        //    method:"PUT",
        //    headers:{"Content-Type":"application/x-www-form-urlencoded"},
        //    body: formData.toString()
        //    })
        //    .then(res=> {
        //    })
        //    .then(data => { 
        //        document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent = val;
        //        editModal.hide();
        //    })
        //    .catch(err=> {
        //    	alert("Ï†ÄÏû• Ïã§Ìå®: " + err)
        //    });
	};


    // Í≤ÄÏÉâÏù¥Î≤§Ìä∏	
    document.getElementById("searchInput").oninput=()=>{
        var cat = document.querySelector("#categoryTabs .nav-link.active").dataset.cat;
        renderTable(cat,document.getElementById("searchInput").value);
    };

    // Ï¥àÍ∏∞Ìôî
    document.getElementById("resetBtn").onclick=()=>{
        document.getElementById("searchInput").value = "";
        renderTable();
    };

	// ÏÉÅÎã® Category
    function setCategory(data){
        var categories = data.map(item => item.category);
        var uniqueCategory = [...new Set(categories)];
        var ul = document.getElementById("categoryTabs");
        var html = `<li class="nav-item"><a class="nav-link active" data-cat="All" href="#">Ï†ÑÏ≤¥</a></li>`;
        uniqueCategory.forEach(category => {
            html += `<li class="nav-item"><a class="nav-link" data-cat="${category}" href="#">${category}</a></li>`;
        })
        ul.innerHTML = html;

		// ÌÉ≠ & Í≤ÄÏÉâ Ïù¥Î≤§Ìä∏
        ul.addEventListener("click", e=> {
            if(e.target && e.target.matches(".nav-link")) {
                document.querySelectorAll("#categoryTabs .nav-link").forEach(t=>t.classList.remove("active")); 
                e.target.classList.add("active"); 
                renderTable(e.target.dataset.cat, document.getElementById("searchInput").value);
            }
        })
    }

    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
	
	// Ï°∞Ìöå
    function getList(){
        fetch("/v1/management/settings/configs")
            .then(res=> { 
                return res.json();
            })
            .then(data=> {
                setCategory(data.configKeys);
                configKeys = data.configKeys;
                renderTable("All");
            })
            .catch(err=>alert("Ï°∞Ìöå Ïã§Ìå®: " + err));
    }

	// Ï≤òÏùå Î°úÎìúÎêòÏóàÏùÑ ÎñÑ 
	getList();
	
</script>
		