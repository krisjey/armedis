<div class="page-content">
    <div class="container-fluid">
    <!-- start page title -->
    <div class="row">
      <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
              <h4 class="mb-sm-0">Redis Config Í¥ÄÎ¶¨Ïûê</h4>

              <div class="page-title-right">
                  <ol class="breadcrumb m-0">
                      <li class="breadcrumb-item"><a href="javascript: void(0);">Armedis</a></li>
                      <li class="breadcrumb-item active">Management</li>
                  </ol>
              </div>
          </div>
      </div>
    </div>
    <!-- end page title -->

    <div class="row">
        <ul class="nav nav-tabs mb-3" id="categoryTabs"></ul>
	
        <!-- Í≤ÄÏÉâÏ∞Ω -->
        <div class="input-group mb-3">
            <span class="input-group-text">üîç</span>
            <input type="text" id="searchInput" class="form-control" placeholder="ÌÇ§ÏõåÎìú Í≤ÄÏÉâ">
            <button id="resetBtn" class="btn btn-outline-secondary">Ï¥àÍ∏∞Ìôî</button>
        </div>
	
        <!-- ÏÑ§Ï†ï ÌÖåÏù¥Î∏î -->
        <table class="table table-striped" id="configTable">
            <thead>
                <tr>
                    <th>ÏÑ§Ï†ï ÌÇ§</th>
                    <th>ÌòÑÏû¨Í∞í</th>
                    <th>ÏÑ§Î™Ö</th>
                    <th>Ìé∏Ïßë</th>
	            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <!-- Ìé∏Ïßë Î™®Îã¨ -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
        <!--      <div class="modal-dialog">-->
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle" ></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>ÌòÑÏû¨Í∞í: <span id="modalCurrent">-</span></p>
                        <div class="alert alert-danger rounded-top alert-solid alert-label-icon border-0 rounded-0 m-0 d-flex align-items-center d-none"
                            role="alert">
                            <i class="ri-error-warning-line label-icon"></i>
                            <div class="flex-grow-1 text-truncate" id="alertMsg"></div>
                        </div>
                        <div id="modalInputContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                        <button type="button" id="saveBtn" class="btn btn-primary">Ï†ÄÏû•</button>
	                </div>
                </div>
            </div>
        </div> 
        <!-- Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loginModalTitle">Lock Screen</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="user-thumb text-center">
                            <img src="/assets/images/users/avatar-3.jpg" class="rounded-circle img-thumbnail avatar-lg" alt="thumbnail">
                            <h5 class="font-size-15 mt-3">krisjey</h5>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" placeholder="Enter username" value="">
                        </div>

                        <form>
                            <div class="mb-3 position-relative">
                                <label class="form-label" for="password-input">Password</label>
                                <div class="position-relative auth-pass-inputgroup mb-3">
                                    <input type="password" class="form-control pe-5 password-input" placeholder="Enter password" id="password-input" value="">
                                    <button class="btn btn-link position-absolute end-0 top-0 text-decoration-none text-muted password-addon" type="button" id="password-addon"><i class="ri-eye-fill align-middle"></i></button>
                                </div>
                            </div>
                        </form>
                        <div class="mt-4">
                            <button type="button" class="btn btn-primary w-100" id="saveLoginBtn">Unlock</button>
                        </div>
                    </div>
                </div>
            </div> 
        </div>
    </div>
    <!-- container-fluid -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
        <div id="liveToast" class="toast hide toast-center" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">ÏïåÎ¶º</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>
</div>
<!-- End Page-content -->  

<script src="/assets/js/common.js"></script>
<!-- password-addon init -->
<script src="/assets/js/pages/password-addon.init.js"></script>

<script>

	// ÏÑ§Ï†ï Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
	var configKeys = [
	//{ key:'maxmemory',            category:'Memory',      description:'ÏµúÎåÄ Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ (Î∞îÏù¥Ìä∏)',           dataType:'number' },
	//{ key:'maxmemory-policy',     category:'Memory',      description:'Î©îÎ™®Î¶¨ Ï¥àÍ≥º Ïãú ÌÇ§ ÏÇ≠Ï†ú Ï†ïÏ±Ö',           dataType:'dropdown', options:['noeviction','allkeys-lru','volatile-lru','volatile-random'] },
	//{ key:'maxclients',           category:'Client',      description:'ÎèôÏãú Ï†ëÏÜç Í∞ÄÎä•Ìïú ÏµúÎåÄ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïàò',    dataType:'number' },
	//{ key:'timeout',              category:'Client',      description:'Ïú†Ìú¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Í≤∞ Ï¢ÖÎ£å ÏãúÍ∞Ñ(Ï¥à)',     dataType:'number' },
	//{ key:'save',                 category:'Persistence', description:'RDB Ïä§ÎÉÖÏÉ∑ Ï£ºÍ∏∞',                      dataType:'text' },
	//{ key:'appendonly',           category:'Persistence', description:'AOF ÏÇ¨Ïö© Ïó¨Î∂Ä',                        dataType:'toggle' },
	//{ key:'appendfsync',          category:'Persistence', description:'AOF ÎèôÍ∏∞Ìôî Ï†ïÏ±Ö',                      dataType:'dropdown', options:['always','everysec','no'] },
	//{ key:'tcp-keepalive',        category:'Network',     description:'TCP keepalive ÏãúÍ∞Ñ(Ï¥à)',               dataType:'number' },
	//{ key:'bind',                 category:'Network',     description:'Î∞îÏù∏ÎìúÌï† IP Î¶¨Ïä§Ìä∏',                    dataType:'text' },
	//{ key:'requirepass',          category:'Security',    description:'ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïù∏Ï¶ù ÎπÑÎ∞ÄÎ≤àÌò∏',              dataType:'password' },
	//{ key:'rename-command',       category:'Security',    description:'Î™ÖÎ†πÏñ¥ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω',                      dataType:'keyvalue' },
	//{ key:'loglevel',             category:'Logging',     description:'Î°úÍ∑∏ Î†àÎ≤®',                            dataType:'dropdown', options:['debug','verbose','notice','warning'] },
	//{ key:'logfile',              category:'Logging',     description:'Î°úÍ∑∏ ÌååÏùº Í≤ΩÎ°ú',                       dataType:'text' },
	//{ key:'cluster-enabled',      category:'Cluster',     description:'ÌÅ¥Îü¨Ïä§ÌÑ∞ Î™®Îìú ÏÇ¨Ïö© Ïó¨Î∂Ä',               dataType:'toggle' },
	//{ key:'cluster-node-timeout', category:'Cluster',     description:'ÌÅ¥Îü¨Ïä§ÌÑ∞ ÎÖ∏Îìú ÌÉÄÏûÑÏïÑÏõÉ(Î∞ÄÎ¶¨Ï¥à)',         dataType:'number' }
	];

	var tableBody = document.querySelector("#configTable tbody");
	var editModal  = new bootstrap.Modal(document.getElementById("editModal"));
    var loginModal = new bootstrap.Modal(document.getElementById("loginModal"), {
        backdrop: 'static' // Î∞îÍπ• ÌÅ¥Î¶≠Ìï¥ÎèÑ Îã´ÌûàÏßÄ ÏïäÏùå
    });
    var currentEdit = null;
	var kvMap = {};
	var editEventObject = null; //ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Í∞ùÏ≤¥
    
	// ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ
	function renderTable(category="All", filter="") {
        tableBody.innerHTML = "";

        if (!configKeys || configKeys.length === 0) {
            initTable();
        } else {
            configKeys.filter(i => (category==="All" || i.category===category) && (i.key.includes(filter) || i.description.includes(filter)))
                    .forEach(i => {
                    var tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${i.key}</td>
                        <td><span class="current-value" data-key="${i.key}">${i.currentValue ?? "-"}</span></td>
                        <td>${i.description}</td>
                        <td><button class="btn btn-sm btn-outline-primary edit-btn" data-key="${i.key}" data-cat="${i.category}">‚úèÔ∏è</button></td>
                        `;
                    tableBody.appendChild(tr);
                    });
            document.querySelectorAll(".edit-btn").forEach(btn => btn.addEventListener("click", openModal));
        }
    }

    // Î™®Îã¨ Ïó¥Í∏∞
    function openModal(e) {
        var event = e.currentTarget.dataset;
        var itemsList = []; 
        var key = event.key;
        var cat = event.cat;
        currentEdit = configKeys.find(i => i.key === key);
        $("#modalTitle").text(`${key} ÏÑ§Ï†ï Î≥ÄÍ≤Ω`);
        $("#modalCurrent").text("Î∂àÎü¨Ïò§Îäî Ï§ë...");
        kvMap = {};

        switch(currentEdit.dataType) {
            case "memoryunit":
                $(".alert")[0].classList.remove("d-none");
                $(".alert > #alertMsg")[0].innerText = 
`# 1k => 1000 bytes
# 1kb => 1024 bytes
# 1m => 1000000 bytes
# 1mb => 1024*1024 bytes
# 1g => 1000000000 bytes
# 1gb => 1024*1024*1024 bytes`;
                break;
            default:
                $(".alert")[0].classList.add("d-none");
        }
        editModal.show();

        // Ï°∞Ìöå
        fetch("/v1/management/settings/config/" + key)
            .then(res=> {
                if (!res.ok) {
                    editModal.hide();
                    console.error(res.statusText);
                    alert("Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî");
                }
                return res.json();
            })
            .then(data=> {
                var currentKey = Object.keys(data.result)[0];
                var currentVal = data.result[currentKey];
                var viewCurrentVal = data.result[currentKey];
                if (!isNaN(viewCurrentVal)) {
                    viewCurrentVal = numberWithCommas(currentVal);
                }
                
                switch(currentEdit.dataType) {
                    case "memoryunit":
                        $("#modalCurrent").text(getMemoryCapacityUnit(currentVal, "kbyte"));
                        break;
                    default:
                        $("#modalCurrent").text(viewCurrentVal);
                }

                if (currentEdit.dataType === "keyvalue") 
                try { 
                    kvMap = JSON.parse(currentVal);
                } catch {
                    $("#modalCurrent").text("-");
                };
                renderModalInput(currentEdit, currentVal);
                
            })
            .catch(err=> {
                console.error(err);
                alert("Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî:" + err);
            	$("#modalCurrent").text("-");
                editModal.hide();
            });
	}
// ÏûÖÎ†• Ïª¥Ìè¨ÎÑåÌä∏ ÏÉùÏÑ±
	function renderModalInput(cfg, curr) {
        var cont = document.getElementById("modalInputContainer");
	    cont.innerHTML = "";
        var html = "";
        switch(cfg.dataType) {
            case "number":
                html = `<input id="modalInput" type="number" class="form-control" value="${curr}">`;
                break;
            case "dropdown":
                html = `<select id="modalInput" class="form-select">${cfg.options.map(o=>`<option value="${o}"${o===curr?' selected':''}>${o}</option>`).join('')}</select>`;
                break;
            case "toggle":
                html = `<div class="form-check form-switch"><input id="modalInput" class="form-check-input" type="checkbox"${curr==='yes'?' checked':''}><label class="form-check-label">${cfg.description}</label></div>`;
                break;
            case "password":
                html = `<input id="modalInput" type="password" class="form-control" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏">`;
                break;
            case "text":
                html = `<textarea id="modalInput" class="form-control" rows="3">${curr}</textarea>`;
                break;
            case "keyvalue":
                html = `<div id="kvContainer" class="mb-2"></div><button id="addKvBtn" class="btn btn-sm btn-outline-secondary mb-3">+ Ï∂îÍ∞Ä</button>`;
                break;
            case "memoryunit":
                html = `<input id="modalInput" type="text" class="form-control" value="${getMemoryCapacityUnit(curr, "kbyte")}">`;
                break;
        }
        cont.innerHTML = html;
        if (cfg.dataType === "keyvalue") initKeyValue();
    }

	// keyvalue Ï¥àÍ∏∞Ìôî Î∞è Î†åÎçî
    function initKeyValue() {
        var kvCont = document.getElementById("kvContainer")
        var addBtn = document.getElementById("addKvBtn");
        addBtn.onclick = () => { 
            kvMap[""] = ""; renderKV();
        };

        function renderKV() {
            kvCont.innerHTML = "";
            Object.entries(kvMap).forEach(([k,v]) => {
                var row = document.createElement("div");
                row.className = "d-flex mb-2";
                row.innerHTML = `<input class="form-control me-2" data-key="key" value="${k}" placeholder="Î™ÖÎ†πÏñ¥">` +
                                `<input class="form-control me-2" data-key="value" value="${v}" placeholder="ÏÉà Ïù¥Î¶Ñ">` +
                                `<button class="btn btn-sm btn-danger">-</button>`;
                row.querySelector("button").onclick=()=>{
                    delete kvMap[k];
                    renderKV();
                };
                row.querySelectorAll("input").forEach(inp=>{
                    inp.oninput=()=>{
                        const newKey=row.querySelector("[data-key=key]").value;
                        const newVal=row.querySelector("[data-key=value]").value;
                        delete kvMap[k]; if(newKey) kvMap[newKey]=newVal; renderKV();
                    };
                });
                kvCont.appendChild(row);
            });
        }
        renderKV();
    }

    // Ï†ÄÏû• Ï≤òÎ¶¨
    document.getElementById("saveBtn").onclick=()=>{
        var val;
        if (currentEdit.dataType === "toggle") val = document.getElementById("modalInput").checked ? "yes":"no";
        else if (currentEdit.dataType === "keyvalue") val = JSON.stringify(kvMap);
        else val = document.getElementById("modalInput").value;
        
        if (val === "" || val === null || val === undefined) {
            alert("Í∞íÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
            return;
        }
        
        if (currentEdit.dataType === "number") {
            if (isNaN(val)) {
                alert("Ïà´Ïûê(0~9)Îßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§.");
                return;
            }
        }

        if (currentEdit.key === 'maxmemory') {
            var memoryPattern = /^\s*\d+?\s*(k|m|g|t)(b)?$/i;
            if (val != 0 && !memoryPattern.test(val)) {
                alert("memory Îã®ÏúÑÏùò Í∞íÏù¥ ÏïÑÎãôÎãàÎã§. Îã§Ïãú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                return;
            }
        }
        //Î™®Îã¨ Ï∞ΩÏóê id, password Í∞Ä ÎÇ®ÏïÑÏûàÏñ¥ ÏßÄÏõÄ
        document.getElementById("username").value = "";
        document.getElementById("password-input").value = "";
        loginModal.show();
	};

    // Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨
    document.getElementById("saveLoginBtn").onclick=()=>{
        var val;
        if (currentEdit.dataType === "toggle") val = document.getElementById("modalInput").checked ? "yes":"no";
        else if (currentEdit.dataType === "keyvalue") val = JSON.stringify(kvMap);
        else val = document.getElementById("modalInput").value;

        var id = document.getElementById("username").value;
        var pwd = document.getElementById("password-input").value;

        if (id === "" || id === null || id === undefined) {
            alert("ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
            return;
        }
        if (pwd === "" || pwd === null || pwd === undefined) {
            alert("ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
            return;
        }

        var loginData = new URLSearchParams();
        loginData.append("loginId", id);
        loginData.append("loginPassword", pwd);

        //Î°úÍ∑∏Ïù∏ Í≤ÄÏ¶ù
        fetch("/v1/management/login", {
            method:"POST",
            headers:{"Content-Type":"application/x-www-form-urlencoded"},
            body: loginData.toString()
        })
        .then(res => res.json())
        .then(loginRes => {
            if (loginRes.hasOwnProperty("result") && loginRes.result.toUpperCase() === "OK") {
                //Ï†ÄÏû•
                var saveData = new URLSearchParams();
                saveData.append("value", val);
                fetch("/v1/management/settings/config/" + currentEdit.key, {
                    method:"PUT",
                    headers:{"Content-Type":"application/x-www-form-urlencoded"},
                    body: saveData.toString()
                })
                .then(res => res.json())
                .then(saveRes => {
                    document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent = val;
                    loginModal.hide();
                    editModal.hide();
                    if (saveRes.hasOwnProperty("result") && saveRes.result.toUpperCase() === "OK") {
                        alert("Ï†ÄÏû• ÏÑ±Í≥µÌïòÏòÄÏäµÎãàÎã§");
                    } else {
                        alert("Ï†ÄÏû• Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§");
                    }
                })
                .catch(err => {
                    alert("Ï†ÄÏû• Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§: " + err)
                });
            } else {
                alert("Î°úÍ∑∏Ïù∏ Ïù∏Ï¶ùÏù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§");
                return;
            }
        })
        .catch(err => {
            alert("Î°úÍ∑∏Ïù∏ Ïù∏Ï¶ùÏù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§");
            console.error("Î°úÍ∑∏Ïù∏ Ïù∏Ï¶ùÏù¥ Ïã§Ìå®ÌïòÏòÄÏäµÎãàÎã§: ", err)
        });
	};

    // Í≤ÄÏÉâÏù¥Î≤§Ìä∏	
    document.getElementById("searchInput").oninput = () => {
        var cat = document.querySelector("#categoryTabs .nav-link.active").dataset.cat;
        renderTable(cat,document.getElementById("searchInput").value);
    };

    // Ï¥àÍ∏∞Ìôî
    document.getElementById("resetBtn").onclick = () => {
        document.getElementById("searchInput").value = "";
        renderTable();
    };

	// ÏÉÅÎã® Category
    function setCategory(data){
        var categories = data.map(item => item.category);
        var uniqueCategory = [...new Set(categories)];
        var ul = document.getElementById("categoryTabs");
        var html = `<li class="nav-item"><a class="nav-link active" data-cat="All" href="#">Ï†ÑÏ≤¥</a></li>`;
        uniqueCategory.forEach(category => {
            html += `<li class="nav-item"><a class="nav-link" data-cat="${category}" href="#">${category}</a></li>`;
        })
        ul.innerHTML = html;

		// ÌÉ≠ & Í≤ÄÏÉâ Ïù¥Î≤§Ìä∏
        ul.addEventListener("click", e => {
            if(e.target && e.target.matches(".nav-link")) {
                document.querySelectorAll("#categoryTabs .nav-link").forEach(t=>t.classList.remove("active")); 
                e.target.classList.add("active"); 
                renderTable(e.target.dataset.cat, document.getElementById("searchInput").value);
            }
        })
    }
    
    // Ï≤úÎã®ÏúÑ ÌëúÏãú
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
	
	// Ï°∞Ìöå
    function getList() {
        fetch("/v1/management/settings/configs")
            .then(res => { 
                return res.json();
            })
            .then(data => {
                setCategory(data.configKeys);
                configKeys = data.configKeys;
                renderTable("All");
            })
            .catch(err =>alert("Ï°∞Ìöå Ïã§Ìå® ÎêòÏóàÏäµÎãàÎã§: " + err));
    }

    function initTable() {
        // Table thead ÏÑ§Ï†ï
        var tr = document.createElement("tr");
        var td = document.createElement("td");
        td.textContent = "Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.";
        td.style.textAlign = "center";
        td.colSpan = 4;
        tr.appendChild(td);
        tableBody.appendChild(tr);
    }

	// Ï≤òÏùå Î°úÎìúÎêòÏóàÏùÑ ÎñÑ 
    initTable();
	getList();
	
</script>

<style>
    .current-value { font-weight: bold; }
</style>