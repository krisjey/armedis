<div class="page-content">
    <div class="container-fluid">
    <!-- start page title -->
    <div class="row">
      <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
              <h4 class="mb-sm-0">Redis Config ê´€ë¦¬ì</h4>

              <div class="page-title-right">
                  <ol class="breadcrumb m-0">
                      <li class="breadcrumb-item"><a href="javascript: void(0);">Armedis</a></li>
                      <li class="breadcrumb-item active">Management</li>
                  </ol>
              </div>
          </div>
      </div>
    </div>
    <!-- end page title -->

    <div class="row">
        <ul class="nav nav-tabs mb-3" id="categoryTabs"></ul>
	
        <!-- ê²€ìƒ‰ì°½ -->
        <div class="input-group mb-3">
            <span class="input-group-text">ğŸ”</span>
            <input type="text" id="searchInput" class="form-control" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰">
            <button id="resetBtn" class="btn btn-outline-secondary">ì´ˆê¸°í™”</button>
        </div>
	
        <!-- ì„¤ì • í…Œì´ë¸” -->
        <table class="table table-striped" id="configTable">
            <thead>
                <tr>
                    <th>ì„¤ì • í‚¤</th>
                    <th>í˜„ì¬ê°’</th>
                    <th>ì„¤ëª…</th>
                    <th>í¸ì§‘</th>
	            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <!-- í¸ì§‘ ëª¨ë‹¬ -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
        <!--      <div class="modal-dialog">-->
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle" ></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>í˜„ì¬ê°’: <span id="modalCurrent">-</span></p>
                        <div class="alert alert-danger rounded-top alert-solid alert-label-icon border-0 rounded-0 m-0 d-flex align-items-center d-none"
                            role="alert">
                            <i class="ri-error-warning-line label-icon"></i>
                            <div class="flex-grow-1 text-truncate" id="alertMsg"></div>
                        </div>
                        <div id="modalInputContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="button" id="saveBtn" class="btn btn-primary">ì €ì¥</button>
	                </div>
                </div>
            </div>
        </div> 
        <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loginModalTitle">Lock Screen</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="user-thumb text-center">
                            <img src="/assets/images/users/avatar-3.jpg" class="rounded-circle img-thumbnail avatar-lg" alt="thumbnail">
                            <h5 class="font-size-15 mt-3">krisjey</h5>
                        </div>
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" placeholder="Enter username" value="">
                        </div>

                        <form>
                            <div class="mb-3 position-relative">
                                <label class="form-label" for="password-input">Password</label>
                                <div class="position-relative auth-pass-inputgroup mb-3">
                                    <input type="password" class="form-control pe-5 password-input" placeholder="Enter password" id="password-input" value="">
                                    <button class="btn btn-link position-absolute end-0 top-0 text-decoration-none text-muted password-addon" type="button" id="password-addon"><i class="ri-eye-fill align-middle"></i></button>
                                </div>
                            </div>
                        </form>
                        <div class="mt-4">
                            <button type="button" class="btn btn-primary w-100" id="saveLoginBtn">Unlock</button>
                        </div>
                    </div>
                </div>
            </div> 
        </div>
    </div>
    <!-- container-fluid -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
        <div id="liveToast" class="toast hide toast-center" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">ì•Œë¦¼</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>
</div>
<!-- End Page-content -->  

<script src="/assets/js/common.js"></script>
<!-- password-addon init -->
<script src="/assets/js/pages/password-addon.init.js"></script>

<script>

	// ì„¤ì • ë©”íƒ€ë°ì´í„°
	var configKeys = [
	//{ key:'maxmemory',            category:'Memory',      description:'ìµœëŒ€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (ë°”ì´íŠ¸)',           dataType:'number' },
	//{ key:'maxmemory-policy',     category:'Memory',      description:'ë©”ëª¨ë¦¬ ì´ˆê³¼ ì‹œ í‚¤ ì‚­ì œ ì •ì±…',           dataType:'dropdown', options:['noeviction','allkeys-lru','volatile-lru','volatile-random'] },
	//{ key:'maxclients',           category:'Client',      description:'ë™ì‹œ ì ‘ì† ê°€ëŠ¥í•œ ìµœëŒ€ í´ë¼ì´ì–¸íŠ¸ ìˆ˜',    dataType:'number' },
	//{ key:'timeout',              category:'Client',      description:'ìœ íœ´ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¢…ë£Œ ì‹œê°„(ì´ˆ)',     dataType:'number' },
	//{ key:'save',                 category:'Persistence', description:'RDB ìŠ¤ëƒ…ìƒ· ì£¼ê¸°',                      dataType:'text' },
	//{ key:'appendonly',           category:'Persistence', description:'AOF ì‚¬ìš© ì—¬ë¶€',                        dataType:'toggle' },
	//{ key:'appendfsync',          category:'Persistence', description:'AOF ë™ê¸°í™” ì •ì±…',                      dataType:'dropdown', options:['always','everysec','no'] },
	//{ key:'tcp-keepalive',        category:'Network',     description:'TCP keepalive ì‹œê°„(ì´ˆ)',               dataType:'number' },
	//{ key:'bind',                 category:'Network',     description:'ë°”ì¸ë“œí•  IP ë¦¬ìŠ¤íŠ¸',                    dataType:'text' },
	//{ key:'requirepass',          category:'Security',    description:'í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ ë¹„ë°€ë²ˆí˜¸',              dataType:'password' },
	//{ key:'rename-command',       category:'Security',    description:'ëª…ë ¹ì–´ ì´ë¦„ ë³€ê²½',                      dataType:'keyvalue' },
	//{ key:'loglevel',             category:'Logging',     description:'ë¡œê·¸ ë ˆë²¨',                            dataType:'dropdown', options:['debug','verbose','notice','warning'] },
	//{ key:'logfile',              category:'Logging',     description:'ë¡œê·¸ íŒŒì¼ ê²½ë¡œ',                       dataType:'text' },
	//{ key:'cluster-enabled',      category:'Cluster',     description:'í´ëŸ¬ìŠ¤í„° ëª¨ë“œ ì‚¬ìš© ì—¬ë¶€',               dataType:'toggle' },
	//{ key:'cluster-node-timeout', category:'Cluster',     description:'í´ëŸ¬ìŠ¤í„° ë…¸ë“œ íƒ€ì„ì•„ì›ƒ(ë°€ë¦¬ì´ˆ)',         dataType:'number' }
	];

	var tableBody = document.querySelector("#configTable tbody");
	var editModal  = new bootstrap.Modal(document.getElementById("editModal"));
    var loginModal = new bootstrap.Modal(document.getElementById("loginModal"), {
        backdrop: 'static' // ë°”ê¹¥ í´ë¦­í•´ë„ ë‹«íˆì§€ ì•ŠìŒ
    });
    var currentEdit = null;
	var kvMap = {};
	var editEventObject = null; //í´ë¦­ ì´ë²¤íŠ¸ ê°ì²´
    
	// í…Œì´ë¸” ë Œë”ë§
	function renderTable(category="All", filter="") {
        tableBody.innerHTML = "";

        if (!configKeys || configKeys.length === 0) {
            initTable();
        } else {
            configKeys.filter(i => (category==="All" || i.category===category) && (i.key.includes(filter) || i.description.includes(filter)))
                    .forEach(i => {
                    var tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${i.key}</td>
                        <td><span class="current-value" data-key="${i.key}">${i.currentValue ?? "-"}</span></td>
                        <td>${i.description}</td>
                        <td><button class="btn btn-sm btn-outline-primary edit-btn" data-key="${i.key}" data-cat="${i.category}">âœï¸</button></td>
                        `;
                    tableBody.appendChild(tr);
                    });
            document.querySelectorAll(".edit-btn").forEach(btn => btn.addEventListener("click", openModal));
        }
    }

    // ëª¨ë‹¬ ì—´ê¸°
    function openModal(e) {
        var event = e.currentTarget.dataset;
        var itemsList = []; 
        var key = event.key;
        var cat = event.cat;
        currentEdit = configKeys.find(i => i.key === key);
        $("#modalTitle").text(`${key} ì„¤ì • ë³€ê²½`);
        $("#modalCurrent").text("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
        kvMap = {};

        switch(currentEdit.dataType) {
            case "memoryunit":
                $(".alert")[0].classList.remove("d-none");
                $(".alert > #alertMsg")[0].innerText = 
`# 1k => 1000 bytes
# 1kb => 1024 bytes
# 1m => 1000000 bytes
# 1mb => 1024*1024 bytes
# 1g => 1000000000 bytes
# 1gb => 1024*1024*1024 bytes`;
                break;
            default:
                $(".alert")[0].classList.add("d-none");
        }
        editModal.show();

        // ì¡°íšŒ
        fetch("/v1/management/settings/config/" + key)
            .then(res=> {
                if (!res.ok) {
                    editModal.hide();
                    console.error(res.statusText);
                    alert("ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”");
                }
                return res.json();
            })
            .then(data=> {
                var currentKey = Object.keys(data.result)[0];
                var currentVal = data.result[currentKey];
                var viewCurrentVal = data.result[currentKey];
                if (!isNaN(viewCurrentVal)) {
                    viewCurrentVal = numberWithCommas(currentVal);
                }
                
                switch(currentEdit.dataType) {
                    case "memoryunit":
                        $("#modalCurrent").text(getMemoryCapacityUnit(currentVal, "kbyte"));
                        break;
                    default:
                        $("#modalCurrent").text(viewCurrentVal);
                }

                if (currentEdit.dataType === "keyvalue") 
                try { 
                    kvMap = JSON.parse(currentVal);
                } catch {
                    $("#modalCurrent").text("-");
                };
                renderModalInput(currentEdit, currentVal);
                
            })
            .catch(err=> {
                console.error(err);
                alert("ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”:" + err);
            	$("#modalCurrent").text("-");
                editModal.hide();
            });
	}
// ì…ë ¥ ì»´í¬ë„ŒíŠ¸ ìƒì„±
	function renderModalInput(cfg, curr) {
        var cont = document.getElementById("modalInputContainer");
	    cont.innerHTML = "";
        var html = "";
        switch(cfg.dataType) {
            case "number":
                html = `<input id="modalInput" type="number" class="form-control" value="${curr}">`;
                break;
            case "dropdown":
                html = `<select id="modalInput" class="form-select">${cfg.options.map(o=>`<option value="${o}"${o===curr?' selected':''}>${o}</option>`).join('')}</select>`;
                break;
            case "toggle":
                html = `<div class="form-check form-switch"><input id="modalInput" class="form-check-input" type="checkbox"${curr==='yes'?' checked':''}><label class="form-check-label">${cfg.description}</label></div>`;
                break;
            case "password":
                html = `<input id="modalInput" type="password" class="form-control" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">`;
                break;
            case "text":
                html = `<textarea id="modalInput" class="form-control" rows="3">${curr}</textarea>`;
                break;
            case "keyvalue":
                html = `<div id="kvContainer" class="mb-2"></div><button id="addKvBtn" class="btn btn-sm btn-outline-secondary mb-3">+ ì¶”ê°€</button>`;
                break;
            case "memoryunit":
                html = `<input id="modalInput" type="text" class="form-control" value="${getMemoryCapacityUnit(curr, "kbyte")}">`;
                break;
        }
        cont.innerHTML = html;
        if (cfg.dataType === "keyvalue") initKeyValue();
    }

	// keyvalue ì´ˆê¸°í™” ë° ë Œë”
    function initKeyValue() {
        var kvCont = document.getElementById("kvContainer")
        var addBtn = document.getElementById("addKvBtn");
        addBtn.onclick = () => { 
            kvMap[""] = ""; renderKV();
        };

        function renderKV() {
            kvCont.innerHTML = "";
            Object.entries(kvMap).forEach(([k,v]) => {
                var row = document.createElement("div");
                row.className = "d-flex mb-2";
                row.innerHTML = `<input class="form-control me-2" data-key="key" value="${k}" placeholder="ëª…ë ¹ì–´">` +
                                `<input class="form-control me-2" data-key="value" value="${v}" placeholder="ìƒˆ ì´ë¦„">` +
                                `<button class="btn btn-sm btn-danger">-</button>`;
                row.querySelector("button").onclick=()=>{
                    delete kvMap[k];
                    renderKV();
                };
                row.querySelectorAll("input").forEach(inp=>{
                    inp.oninput=()=>{
                        const newKey=row.querySelector("[data-key=key]").value;
                        const newVal=row.querySelector("[data-key=value]").value;
                        delete kvMap[k]; if(newKey) kvMap[newKey]=newVal; renderKV();
                    };
                });
                kvCont.appendChild(row);
            });
        }
        renderKV();
    }

    // ì €ì¥ ì²˜ë¦¬
    document.getElementById("saveBtn").onclick=()=>{
        var val;
        if (currentEdit.dataType === "toggle") val = document.getElementById("modalInput").checked ? "yes":"no";
        else if (currentEdit.dataType === "keyvalue") val = JSON.stringify(kvMap);
        else val = document.getElementById("modalInput").value;
        
        if (val === "" || val === null || val === undefined) {
            alert("ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
            return;
        }
        
        if (currentEdit.dataType === "number") {
            if (isNaN(val)) {
                alert("ìˆ«ì(0~9)ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }
        }

        if (currentEdit.key === 'maxmemory') {
            var memoryPattern = /^\s*\d+?\s*(k|m|g|t)(b)?$/i;
            if (val != 0 && !memoryPattern.test(val)) {
                alert("memory ë‹¨ìœ„ì˜ ê°’ì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
        }
        //ëª¨ë‹¬ ì°½ì— id, password ê°€ ë‚¨ì•„ìˆì–´ ì§€ì›€
        document.getElementById("username").value = "";
        document.getElementById("password-input").value = "";
        loginModal.show();
	};

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    document.getElementById("saveLoginBtn").onclick=()=>{
        var val;
        if (currentEdit.dataType === "toggle") val = document.getElementById("modalInput").checked ? "yes":"no";
        else if (currentEdit.dataType === "keyvalue") val = JSON.stringify(kvMap);
        else val = document.getElementById("modalInput").value;

        var id = document.getElementById("username").value;
        var pwd = document.getElementById("password-input").value;

        if (id === "" || id === null || id === undefined) {
            alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
            return;
        }
        if (pwd === "" || pwd === null || pwd === undefined) {
            alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
            return;
        }

        var loginData = new URLSearchParams();
        loginData.append("loginId", id);
        loginData.append("loginPassword", pwd);

        //ë¡œê·¸ì¸ ê²€ì¦
        fetch("/v1/management/login", {
            method:"POST",
            headers:{"Content-Type":"application/x-www-form-urlencoded"},
            body: loginData.toString()
        })
        .then(res => res.json())
        .then(loginRes => {
            if (loginRes.hasOwnProperty("result") && loginRes.result.toUpperCase() === "OK") {
                //ì €ì¥
                var saveData = new URLSearchParams();
                saveData.append("value", val);
                fetch("/v1/management/settings/config/" + currentEdit.key, {
                    method:"PUT",
                    headers:{"Content-Type":"application/x-www-form-urlencoded"},
                    body: saveData.toString()
                })
                .then(res => res.json())
                .then(saveRes => {
                    document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent = val;
                    loginModal.hide();
                    editModal.hide();
                    if (saveRes.hasOwnProperty("result") && saveRes.result.toUpperCase() === "OK") {
                        alert("ì €ì¥ ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤");
                    } else {
                        alert("ì €ì¥ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤");
                    }
                })
                .catch(err => {
                    alert("ì €ì¥ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤: " + err)
                });
            } else {
                alert("ë¡œê·¸ì¸ ì¸ì¦ì´ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤");
                return;
            }
        })
        .catch(err => {
            alert("ë¡œê·¸ì¸ ì¸ì¦ì´ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤");
            console.error("ë¡œê·¸ì¸ ì¸ì¦ì´ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤: ", err)
        });
	};

    // ê²€ìƒ‰ì´ë²¤íŠ¸	
    document.getElementById("searchInput").oninput = () => {
        var cat = document.querySelector("#categoryTabs .nav-link.active").dataset.cat;
        renderTable(cat,document.getElementById("searchInput").value);
    };

    // ì´ˆê¸°í™”
    document.getElementById("resetBtn").onclick = () => {
        document.getElementById("searchInput").value = "";
        renderTable();
    };

	// ìƒë‹¨ Category
    function setCategory(data){
        var categories = data.map(item => item.category);
        var uniqueCategory = [...new Set(categories)];
        var ul = document.getElementById("categoryTabs");
        var html = `<li class="nav-item"><a class="nav-link active" data-cat="All" href="#">ì „ì²´</a></li>`;
        uniqueCategory.forEach(category => {
            html += `<li class="nav-item"><a class="nav-link" data-cat="${category}" href="#">${category}</a></li>`;
        })
        ul.innerHTML = html;

		// íƒ­ & ê²€ìƒ‰ ì´ë²¤íŠ¸
        ul.addEventListener("click", e => {
            if(e.target && e.target.matches(".nav-link")) {
                document.querySelectorAll("#categoryTabs .nav-link").forEach(t=>t.classList.remove("active")); 
                e.target.classList.add("active"); 
                renderTable(e.target.dataset.cat, document.getElementById("searchInput").value);
            }
        })
    }
    
    // ì²œë‹¨ìœ„ í‘œì‹œ
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
	
	// ì¡°íšŒ
    function getList() {
        fetch("/v1/management/settings/configs")
            .then(res => { 
                return res.json();
            })
            .then(data => {
                setCategory(data.configKeys);
                configKeys = data.configKeys;
                renderTable("All");
            })
            .catch(err =>alert("ì¡°íšŒ ì‹¤íŒ¨ ë˜ì—ˆìŠµë‹ˆë‹¤: " + err));
    }

    function initTable() {
        // Table thead ì„¤ì •
        var tr = document.createElement("tr");
        var td = document.createElement("td");
        td.textContent = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        td.style.textAlign = "center";
        td.colSpan = 4;
        tr.appendChild(td);
        tableBody.appendChild(tr);
    }

	// ì²˜ìŒ ë¡œë“œë˜ì—ˆì„ ë–„ 
    initTable();
	getList();
	
</script>

<style>
    .current-value { font-weight: bold; }
</style>