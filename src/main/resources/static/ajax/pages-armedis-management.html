<div class="page-content">
    <div class="container-fluid">
    <!-- start page title -->
    <div class="row">
      <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
              <h4 class="mb-sm-0">Redis Config ê´€ë¦¬ì</h4>

              <div class="page-title-right">
                  <ol class="breadcrumb m-0">
                      <li class="breadcrumb-item"><a href="javascript: void(0);">Armedis</a></li>
                      <li class="breadcrumb-item active">Management</li>
                  </ol>
              </div>
          </div>
      </div>
    </div>
    <!-- end page title -->

    <div class="row">
        <ul class="nav nav-tabs mb-3" id="categoryTabs"></ul>
	
        <!-- ê²€ìƒ‰ì°½ -->
        <div class="input-group mb-3">
            <span class="input-group-text">ğŸ”</span>
            <input type="text" id="searchInput" class="form-control" placeholder="í‚¤ì›Œë“œ ê²€ìƒ‰">
            <button id="resetBtn" class="btn btn-outline-secondary">ì´ˆê¸°í™”</button>
        </div>
	
        <!-- ì„¤ì • í…Œì´ë¸” -->
        <table class="table table-striped" id="configTable">
            <thead>
                <tr>
                    <th>ì„¤ì • í‚¤</th>
                    <th>í˜„ì¬ê°’</th>
                    <th>ì„¤ëª…</th>
                    <th>í¸ì§‘</th>
	            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <!-- í¸ì§‘ ëª¨ë‹¬ -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
        <!--      <div class="modal-dialog">-->
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>í˜„ì¬ê°’: <span id="modalCurrent">-</span></p>
                        <div id="modalInputContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                        <button type="button" id="saveBtn" class="btn btn-primary">ì €ì¥</button>
	                </div>
                </div>
            </div>
        </div> 
        <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
        <!--      <div class="modal-dialog">-->
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loginModalTitle">Login</h5>
                    </div>
                    <div class="modal-body">
                        <div id="modalInputContainer">
                            <input id="loginModalInputId" type="text" class="form-control" value="admin" placeholder="ID">
                            <input id="loginModalInputPassword" type="password" class="form-control" value="ezwel1234" placeholder="PASSWORD">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="saveLoginBtn" class="btn btn-primary w-100">ë¡œê·¸ì¸</button>
	                </div>
                </div>
            </div>
        </div> 
    </div>
    <!-- container-fluid -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
        <div id="liveToast" class="toast hide toast-center" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">ì•Œë¦¼</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>
</div>
<!-- End Page-content -->  

<script src="/assets/js/common.js"></script>

<style>
	.current-value { font-weight: bold; }
</style>
<!-- ë¡œì»¬ JS ì°¸ì¡° -->
<!-- <script src="/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script> -->

<script>
	// ì„¤ì • ë©”íƒ€ë°ì´í„°
	var configKeys = [
	//{ key:'maxmemory',            category:'Memory',      description:'ìµœëŒ€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (ë°”ì´íŠ¸)',           dataType:'number' },
	//{ key:'maxmemory-policy',     category:'Memory',      description:'ë©”ëª¨ë¦¬ ì´ˆê³¼ ì‹œ í‚¤ ì‚­ì œ ì •ì±…',           dataType:'dropdown', options:['noeviction','allkeys-lru','volatile-lru','volatile-random'] },
	//{ key:'maxclients',           category:'Client',      description:'ë™ì‹œ ì ‘ì† ê°€ëŠ¥í•œ ìµœëŒ€ í´ë¼ì´ì–¸íŠ¸ ìˆ˜',    dataType:'number' },
	//{ key:'timeout',              category:'Client',      description:'ìœ íœ´ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì¢…ë£Œ ì‹œê°„(ì´ˆ)',     dataType:'number' },
	//{ key:'save',                 category:'Persistence', description:'RDB ìŠ¤ëƒ…ìƒ· ì£¼ê¸°',                      dataType:'text' },
	//{ key:'appendonly',           category:'Persistence', description:'AOF ì‚¬ìš© ì—¬ë¶€',                        dataType:'toggle' },
	//{ key:'appendfsync',          category:'Persistence', description:'AOF ë™ê¸°í™” ì •ì±…',                      dataType:'dropdown', options:['always','everysec','no'] },
	//{ key:'tcp-keepalive',        category:'Network',     description:'TCP keepalive ì‹œê°„(ì´ˆ)',               dataType:'number' },
	//{ key:'bind',                 category:'Network',     description:'ë°”ì¸ë“œí•  IP ë¦¬ìŠ¤íŠ¸',                    dataType:'text' },
	//{ key:'requirepass',          category:'Security',    description:'í´ë¼ì´ì–¸íŠ¸ ì¸ì¦ ë¹„ë°€ë²ˆí˜¸',              dataType:'password' },
	//{ key:'rename-command',       category:'Security',    description:'ëª…ë ¹ì–´ ì´ë¦„ ë³€ê²½',                      dataType:'keyvalue' },
	//{ key:'loglevel',             category:'Logging',     description:'ë¡œê·¸ ë ˆë²¨',                            dataType:'dropdown', options:['debug','verbose','notice','warning'] },
	//{ key:'logfile',              category:'Logging',     description:'ë¡œê·¸ íŒŒì¼ ê²½ë¡œ',                       dataType:'text' },
	//{ key:'cluster-enabled',      category:'Cluster',     description:'í´ëŸ¬ìŠ¤í„° ëª¨ë“œ ì‚¬ìš© ì—¬ë¶€',               dataType:'toggle' },
	//{ key:'cluster-node-timeout', category:'Cluster',     description:'í´ëŸ¬ìŠ¤í„° ë…¸ë“œ íƒ€ì„ì•„ì›ƒ(ë°€ë¦¬ì´ˆ)',         dataType:'number' }
	];

	var tableBody = document.querySelector("#configTable tbody");
	var editModal  = new bootstrap.Modal(document.getElementById("editModal"));
    var loginModal = new bootstrap.Modal(document.getElementById("loginModal"), {
        backdrop: 'static' // ë°”ê¹¥ í´ë¦­í•´ë„ ë‹«íˆì§€ ì•ŠìŒ
    });
    var currentEdit = null;
	var kvMap = {};
	var editEventObject = null; //í´ë¦­ ì´ë²¤íŠ¸ ê°ì²´

	// í…Œì´ë¸” ë Œë”ë§
	function renderTable(category="All", filter="") {
        tableBody.innerHTML = "";
        configKeys.filter(i => (category==="All" || i.category===category) && (i.key.includes(filter) || i.description.includes(filter)))
	               .forEach(i => {
                  var tr = document.createElement("tr");
                  tr.innerHTML = `
                    <td>${i.key}</td>
                    <td><span class="current-value" data-key="${i.key}">${i.currentValue ?? "-"}</span></td>
                    <td>${i.description}</td>
                    <td><button class="btn btn-sm btn-outline-primary edit-btn" data-key="${i.key}" data-cat="${i.category}">âœï¸</button></td>
                    `;
                  tableBody.appendChild(tr);
                });
       document.querySelectorAll(".edit-btn").forEach(btn => btn.addEventListener("click", openModal));
    }


    // ëª¨ë‹¬ ì—´ê¸°
    function openModal(e) {
        // ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸°
        editEventObject = e.currentTarget.dataset;
        loginModal.show();
	}

    // ëª¨ë‹¬ ì—´ê¸°
    function openEditModal(e) {
        var itemsList = []; 
        var key = e.key;
        var cat = e.cat;
        currentEdit = configKeys.find(i => i.key === key);
        document.getElementById("modalTitle").textContent = `${key} ì„¤ì • ë³€ê²½`;
        document.getElementById("modalCurrent").textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        kvMap = {};
        renderModalInput(currentEdit, "");
        editModal.show();
//       // ì¡°íšŒ
        fetch("/v1/management/settings/config/" + key)
            .then(res=> {
                if (!res.ok) {
                    editModal.hide();
                    throw new Error('ì¡°íšŒ ì‹¤íŒ¨ : ' + res.statusText);
                }
                return res.json();
            })
            .then(data=> {
                var currentKey = Object.keys(data.result)[0];
                var currentVal = data.result[currentKey];
                var viewCurrentVal = data.result[currentKey];
                if (!isNaN(viewCurrentVal)) {
                    viewCurrentVal = numberWithCommas(currentVal);
                }
                document.getElementById("modalCurrent").textContent = viewCurrentVal;
                if (currentEdit.dataType === "keyvalue") 
                try { 
                    kvMap = JSON.parse(currentVal);
                } catch {
                    document.getElementById("modalCurrent").textContent = "-";
                };
                renderModalInput(currentEdit, currentVal);
            })
            .catch(err=> {
                alert('ì¡°íšŒ ì‹¤íŒ¨' + err);
            	document.getElementById("modalCurrent").textContent = "-";
                editModal.hide();
            });
	}
// ì…ë ¥ ì»´í¬ë„ŒíŠ¸ ìƒì„±
	function renderModalInput(cfg, curr) {
        var cont = document.getElementById("modalInputContainer");
	    cont.innerHTML = "";
        var html = "";
        switch(cfg.dataType) {
            case "number":
                html = `<input id="modalInput" type="number" class="form-control" value="${curr}">`;
                break;
            case "dropdown":
                html = `<select id="modalInput" class="form-select">${cfg.options.map(o=>`<option value="${o}"${o===curr?' selected':''}>${o}</option>`).join('')}</select>`;
                break;
            case "toggle":
                html = `<div class="form-check form-switch"><input id="modalInput" class="form-check-input" type="checkbox"${curr==='yes'?' checked':''}><label class="form-check-label">${cfg.description}</label></div>`;
                break;
            case "password":
                html = `<input id="modalInput" type="password" class="form-control" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">`;
                break;
            case "text":
                html = `<textarea id="modalInput" class="form-control" rows="3">${curr}</textarea>`;
                break;
            case "keyvalue":
                html = `<div id="kvContainer" class="mb-2"></div><button id="addKvBtn" class="btn btn-sm btn-outline-secondary mb-3">+ ì¶”ê°€</button>`;
                break;
        }
        cont.innerHTML = html;
        if (cfg.dataType === "keyvalue") initKeyValue();
    }

	// keyvalue ì´ˆê¸°í™” ë° ë Œë”
    function initKeyValue() {
        var kvCont = document.getElementById("kvContainer")
        var addBtn = document.getElementById("addKvBtn");
        addBtn.onclick = () => { 
            kvMap[""] = ""; renderKV();
        };

        function renderKV() {
            kvCont.innerHTML = "";
            Object.entries(kvMap).forEach(([k,v]) => {
                var row = document.createElement("div");
                row.className = "d-flex mb-2";
                row.innerHTML = `<input class="form-control me-2" data-key="key" value="${k}" placeholder="ëª…ë ¹ì–´">` +
                                `<input class="form-control me-2" data-key="value" value="${v}" placeholder="ìƒˆ ì´ë¦„">` +
                                `<button class="btn btn-sm btn-danger">-</button>`;
                row.querySelector("button").onclick=()=>{
                    delete kvMap[k];
                    renderKV();
                };
                row.querySelectorAll("input").forEach(inp=>{
                    inp.oninput=()=>{
                        const newKey=row.querySelector("[data-key=key]").value;
                        const newVal=row.querySelector("[data-key=value]").value;
                        delete kvMap[k]; if(newKey) kvMap[newKey]=newVal; renderKV();
                    };
                });
                kvCont.appendChild(row);
            });
        }
        renderKV();
    }

    // ì €ì¥ ì²˜ë¦¬
    document.getElementById("saveBtn").onclick=()=>{
        var val;
        if (currentEdit.dataType === "toggle") val = document.getElementById("modalInput").checked ? "yes":"no";
        else if (currentEdit.dataType === "keyvalue") val = JSON.stringify(kvMap);
        else val = document.getElementById("modalInput").value;
        
        if (value === "" || value === null || value === undefined) {
            alert("ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
            return;
        }
        
        if (currentEdit.dataType === "number") {
            if (isNaN(val)) {
                alert("ìˆ«ìí˜•ì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”");
                return;
            }
        }

        //TODO: login api ë‚˜ì˜¤ë©´ ë³€ê²½
        $.ajax({
            url: '../assets/json/login-verify.json',
            method: "GET",
            beforeSend: function(xhr) {
                var token = sessionStorage.getItem("auth-token");
                if (token) xhr.setRequestHeader("auth-token", token);
            },
            success: function(data) {
                if (data.result) {
                    //ì €ì¥
                    var formData = new URLSearchParams();
                    formData.append("value", val);
                    fetch("/v1/management/settings/config/" + currentEdit.key, {
                        method:"PUT",
                        headers:{"Content-Type":"application/x-www-form-urlencoded"},
                        body: formData.toString()
                        })
                        .then(res=> {
                        })
                        .then(data => { 
                            document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent = val;
                            editModal.hide();
                        })
                        .catch(err=> {
                            alert("ì €ì¥ ì‹¤íŒ¨: " + err)
                        });
                } else {
                    alert("ë¡œê·¸ì¸ ê²€ì¦ ì‹¤íŒ¨");
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        })


        //var formData = new URLSearchParams();
        //formData.append("value", val);
        //
        //// ì €ì¥
        //fetch("/v1/management/settings/config/" + currentEdit.key, {
        //    method:"PUT",
        //    headers:{"Content-Type":"application/x-www-form-urlencoded"},
        //    body: formData.toString()
        //    })
        //    .then(res=> {
        //    })
        //    .then(data => { 
        //        document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent = val;
        //        editModal.hide();
        //    })
        //    .catch(err=> {
        //    	alert("ì €ì¥ ì‹¤íŒ¨: " + err)
        //    });
	};//

    // ë¡œê·¸ì¸ ì²˜ë¦¬
    document.getElementById("saveLoginBtn").onclick=()=>{
        var id = document.getElementById("loginModalInputId").value;
        var pwd = document.getElementById("loginModalInputPassword").value;
        
        if (id != 'admin' || pwd != 'ezwel1234') {
            alert("ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤");
            return;
        }

        // TODO: ë¡œê·¸ì¸ api ë‚˜ì˜¤ë©´ ë³€ê²½
        $.ajax({
            url: '../assets/json/login.json',
            method: "GET",
            dataType: "json",
            success: function(data) {
                if (data.result) {
                    sessionStorage.setItem("auth-token", data.token);
                    loginModal.hide();
                    openEditModal(editEventObject);
                    editEventObject = null; // ì¬ì‚¬ìš© ë°©ì§€
                } else {
                    alert("ë¡œê·¸ì¸ ì¸ì¦ì´ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤");
                    return;
                }
            },
            error: function(xhr, status, error) {
                alert(error);
            }
        })


        // ì €ì¥
        //var formData = new URLSearchParams();
        //formData.append("value", val);
        //fetch("/v1/management/settings/config/" + currentEdit.key, {
        //    method:"PUT",
        //    headers:{"Content-Type":"application/x-www-form-urlencoded"},
        //    body: formData.toString()
        //    })
        //    .then(res=> {
        //    })
        //    .then(data => { 
        //        document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent = val;
        //        editModal.hide();
        //    })
        //    .catch(err=> {
        //    	alert("ì €ì¥ ì‹¤íŒ¨: " + err)
        //    });
	};


    // ê²€ìƒ‰ì´ë²¤íŠ¸	
    document.getElementById("searchInput").oninput=()=>{
        var cat = document.querySelector("#categoryTabs .nav-link.active").dataset.cat;
        renderTable(cat,document.getElementById("searchInput").value);
    };

    // ì´ˆê¸°í™”
    document.getElementById("resetBtn").onclick=()=>{
        document.getElementById("searchInput").value = "";
        renderTable();
    };

	// ìƒë‹¨ Category
    function setCategory(data){
        var categories = data.map(item => item.category);
        var uniqueCategory = [...new Set(categories)];
        var ul = document.getElementById("categoryTabs");
        var html = `<li class="nav-item"><a class="nav-link active" data-cat="All" href="#">ì „ì²´</a></li>`;
        uniqueCategory.forEach(category => {
            html += `<li class="nav-item"><a class="nav-link" data-cat="${category}" href="#">${category}</a></li>`;
        })
        ul.innerHTML = html;

		// íƒ­ & ê²€ìƒ‰ ì´ë²¤íŠ¸
        ul.addEventListener("click", e=> {
            if(e.target && e.target.matches(".nav-link")) {
                document.querySelectorAll("#categoryTabs .nav-link").forEach(t=>t.classList.remove("active")); 
                e.target.classList.add("active"); 
                renderTable(e.target.dataset.cat, document.getElementById("searchInput").value);
            }
        })
    }

    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
	
	// ì¡°íšŒ
    function getList(){
        fetch("/v1/management/settings/configs")
            .then(res=> { 
                return res.json();
            })
            .then(data=> {
                setCategory(data.configKeys);
                configKeys = data.configKeys;
                renderTable("All");
            })
            .catch(err=>alert("ì¡°íšŒ ì‹¤íŒ¨: " + err));
    }

	// ì²˜ìŒ ë¡œë“œë˜ì—ˆì„ ë–„ 
	getList();
	
</script>
		