<div class="page-content">
    <div class="container-fluid">
    <!-- start page title -->
    <div class="row">
      <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
              <h4 class="mb-sm-0">Redis Config Í¥ÄÎ¶¨Ïûê</h4>
  
              <div class="page-title-right">
                  <ol class="breadcrumb m-0">
                      <li class="breadcrumb-item"><a href="javascript: void(0);">Armedis</a></li>
                      <li class="breadcrumb-item active">Management</li>
                  </ol>
              </div>
  
          </div>
      </div>
    </div>
    <!-- end page title -->
  
    <div class="row">
      <ul class="nav nav-tabs mb-3" id="categoryTabs">
        <li class="nav-item"><a class="nav-link active" data-cat="All" href="#">Ï†ÑÏ≤¥</a></li>
        <li class="nav-item"><a class="nav-link" data-cat="Memory" href="#">Memory</a></li>
        <li class="nav-item"><a class="nav-link" data-cat="Clients" href="#">Clients</a></li>
        <li class="nav-item"><a class="nav-link" data-cat="Persistence" href="#">Persistence</a></li>
        <li class="nav-item"><a class="nav-link" data-cat="Network" href="#">Network</a></li>
        <li class="nav-item"><a class="nav-link" data-cat="Security" href="#">Security</a></li>
        <li class="nav-item"><a class="nav-link" data-cat="Logging" href="#">Logging</a></li>
        <li class="nav-item"><a class="nav-link" data-cat="Cluster" href="#">Cluster</a></li>
      </ul>
      
      <!-- Í≤ÄÏÉâÏ∞Ω -->
      <div class="input-group mb-3">
        <span class="input-group-text">üîç</span>
        <input type="text" id="searchInput" class="form-control" placeholder="ÌÇ§ÏõåÎìú Í≤ÄÏÉâ">
        <button id="resetBtn" class="btn btn-outline-secondary">Ï¥àÍ∏∞Ìôî</button>
      </div>
      
      <!-- ÏÑ§Ï†ï ÌÖåÏù¥Î∏î -->
      <table class="table table-striped" id="configTable">
        <thead>
          <tr>
            <th>ÏÑ§Ï†ï ÌÇ§</th>
            <th>ÌòÑÏû¨Í∞í</th>
            <th>ÏÑ§Î™Ö</th>
            <th>Ìé∏Ïßë</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <!-- Ìé∏Ïßë Î™®Îã¨ -->
      <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true" style="position: fixed;">
  <!--      <div class="modal-dialog">-->
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle"></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p>ÌòÑÏû¨Í∞í: <span id="modalCurrent">-</span></p>
              <div id="modalInputContainer"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
              <button type="button" id="saveBtn" class="btn btn-primary">Ï†ÄÏû•</button>
            </div>
          </div>
        </div>
      </div> 
    </div>
    <!-- container-fluid -->
  </div>
  <!-- End Page-content -->  
  
  <script src="/assets/js/common.js"></script>
  
  <style>
      .current-value { font-weight: bold; }
  </style>
  <!-- Î°úÏª¨ JS Ï∞∏Ï°∞ -->
  <!-- <script src="/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script> -->
  
  <script>
      // ÏÑ§Ï†ï Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
      var configKeys = [
      //{ key:'maxmemory',            cat:'Memory',      desc:'ÏµúÎåÄ Î©îÎ™®Î¶¨ ÏÇ¨Ïö©Îüâ (Î∞îÏù¥Ìä∏)',               type:'number' },
      //{ key:'maxmemory-policy',     cat:'Memory',      desc:'Î©îÎ™®Î¶¨ Ï¥àÍ≥º Ïãú ÌÇ§ ÏÇ≠Ï†ú Ï†ïÏ±Ö',               type:'dropdown', options:['noeviction','allkeys-lru','volatile-lru','volatile-random'] },
      //{ key:'maxclients',           cat:'Client',      desc:'ÎèôÏãú Ï†ëÏÜç Í∞ÄÎä•Ìïú ÏµúÎåÄ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïàò',         type:'number' },
      //{ key:'timeout',              cat:'Client',      desc:'Ïú†Ìú¥ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Í≤∞ Ï¢ÖÎ£å ÏãúÍ∞Ñ(Ï¥à)',         type:'number' },
      //{ key:'save',                 cat:'Persistence', desc:'RDB Ïä§ÎÉÖÏÉ∑ Ï£ºÍ∏∞',                          type:'text' },
      //{ key:'appendonly',           cat:'Persistence', desc:'AOF ÏÇ¨Ïö© Ïó¨Î∂Ä',                            type:'toggle' },
      //{ key:'appendfsync',          cat:'Persistence', desc:'AOF ÎèôÍ∏∞Ìôî Ï†ïÏ±Ö',                          type:'dropdown', options:['always','everysec','no'] },
      //{ key:'tcp-keepalive',        cat:'Network',     desc:'TCP keepalive ÏãúÍ∞Ñ(Ï¥à)',                    type:'number' },
      //{ key:'bind',                 cat:'Network',     desc:'Î∞îÏù∏ÎìúÌï† IP Î¶¨Ïä§Ìä∏',                          type:'text' },
      //{ key:'requirepass',          cat:'Security',    desc:'ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïù∏Ï¶ù ÎπÑÎ∞ÄÎ≤àÌò∏',                    type:'password' },
      //{ key:'rename-command',       cat:'Security',    desc:'Î™ÖÎ†πÏñ¥ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω',                          type:'keyvalue' },
      //{ key:'loglevel',             cat:'Logging',     desc:'Î°úÍ∑∏ Î†àÎ≤®',                                 type:'dropdown', options:['debug','verbose','notice','warning'] },
      //{ key:'logfile',              cat:'Logging',     desc:'Î°úÍ∑∏ ÌååÏùº Í≤ΩÎ°ú',                             type:'text' },
      //{ key:'cluster-enabled',      cat:'Cluster',     desc:'ÌÅ¥Îü¨Ïä§ÌÑ∞ Î™®Îìú ÏÇ¨Ïö© Ïó¨Î∂Ä',                    type:'toggle' },
      //{ key:'cluster-node-timeout', cat:'Cluster',     desc:'ÌÅ¥Îü¨Ïä§ÌÑ∞ ÎÖ∏Îìú ÌÉÄÏûÑÏïÑÏõÉ(Î∞ÄÎ¶¨Ï¥à)',              type:'number' }
      ];
  
      var tableBody = document.querySelector("#configTable tbody");
      var editModal  = new bootstrap.Modal(document.getElementById("editModal"));
      var currentEdit = null;
      var kvMap = {};
      var allItems = [];
  
      // ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ
      function renderTable(cat="All", filter="") {
        tableBody.innerHTML = "";
        configKeys.filter(i => (cat==="All" || i.cat===cat) && (i.key.includes(filter) || i.desc.includes(filter)))
                  .forEach(i => {
                    var tr = document.createElement("tr");
                    tr.innerHTML = `
                      <td>${i.key}</td>
                      <td><span class="current-value" data-key="${i.key}">${i.val ?? "-"}</span></td>
                      <td>${i.desc}</td>
                      <td><button class="btn btn-sm btn-outline-primary edit-btn" data-key="${i.key}" data-cat="${i.cat}">‚úèÔ∏è</button></td>
                      `;
                    tableBody.appendChild(tr);
                  });
        document.querySelectorAll(".edit-btn").forEach(btn => btn.addEventListener("click", openModal));
      }
  
      // Î™®Îã¨ Ïó¥Í∏∞
      function openModal(e) {
          var itemsList = []; 
          var key = e.currentTarget.dataset.key;
          var cat = e.currentTarget.dataset.cat;
          currentEdit = configKeys.find(i => i.key === key);
          document.getElementById("modalTitle").textContent = `${key} ÏÑ§Ï†ï Î≥ÄÍ≤Ω`;
          document.getElementById("modalCurrent").textContent = "Î∂àÎü¨Ïò§Îäî Ï§ë...";
          kvMap = {};
          renderModalInput(currentEdit, "");
          editModal.show();
          
          itemsList = configKeys.filter(item => item.key === key && item.cat === cat)[0];
          var currentVal = itemsList.val ?? "";
  
          document.getElementById("modalCurrent").textContent = currentVal;
          if (currentEdit.type==="keyvalue") 
          try { 
              kvMap = JSON.parse(currentVal);
          } catch {
              document.getElementById("modalCurrent").textContent = "-";
          };
          renderModalInput(currentEdit, currentVal);
  
        //fetch(`/api/config/current?key=${key}`)
      //	.then(res => res.json())
      //	.then(data => {
      //	  document.getElementById('modalCurrent').textContent = data.value;
      //	  if (currentEdit.type==='keyvalue') try { kvMap = JSON.parse(data.value); } catch {};
      //	    renderModalInput(currentEdit, data.value);
      //	})
      //	.catch(() => document.getElementById('modalCurrent').textContent = '-');
      }
  
      // ÏûÖÎ†• Ïª¥Ìè¨ÎÑåÌä∏ ÏÉùÏÑ±
      function renderModalInput(cfg, curr) {
        var cont = document.getElementById("modalInputContainer");
        cont.innerHTML = "";
        var html = "";
        switch(cfg.type) {
           case "number":
           html = `<input id="modalInput" type="number" class="form-control" value="${curr}">`;
           break;
           case "dropdown":
           html = `<select id="modalInput" class="form-select">${cfg.options.map(o=>`<option value="${o}"${o===curr?' selected':''}>${o}</option>`).join('')}</select>`;
           break;
           case "toggle":
           html = `<div class="form-check form-switch"><input id="modalInput" class="form-check-input" type="checkbox"${curr==='yes'?' checked':''}><label class="form-check-label">${cfg.desc}</label></div>`;
           break;
           case "password":
           html = `<input id="modalInput" type="password" class="form-control" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏">`;
           break;
           case "text":
           html = `<textarea id="modalInput" class="form-control" rows="3">${curr}</textarea>`;
           break;
           case "keyvalue":
           html = `<div id="kvContainer" class="mb-2"></div><button id="addKvBtn" class="btn btn-sm btn-outline-secondary mb-3">+ Ï∂îÍ∞Ä</button>`;
           break;
        }
        cont.innerHTML = html;
        if (cfg.type === "keyvalue") initKeyValue();
      }
  
      // keyvalue Ï¥àÍ∏∞Ìôî Î∞è Î†åÎçî
      function initKeyValue() {
          var kvCont = document.getElementById("kvContainer"), addBtn = document.getElementById("addKvBtn");
          addBtn.onclick = () => { 
              kvMap[""] = ""; renderKV();
          };
  
          function renderKV() {
              kvCont.innerHTML = "";
              Object.entries(kvMap).forEach(([k,v]) => {
                  var row = document.createElement("div");
                  row.className = "d-flex mb-2";
                  row.innerHTML = `<input class="form-control me-2" data-key="key" value="${k}" placeholder="Î™ÖÎ†πÏñ¥">` +
                                  `<input class="form-control me-2" data-key="value" value="${v}" placeholder="ÏÉà Ïù¥Î¶Ñ">` +
                                  `<button class="btn btn-sm btn-danger">-</button>`;
                  row.querySelector("button").onclick=()=>{
                      delete kvMap[k];
                      renderKV();
                  };
                  row.querySelectorAll("input").forEach(inp=>{
                      inp.oninput=()=>{
                          const newKey=row.querySelector("[data-key=key]").value;
                          const newVal=row.querySelector("[data-key=value]").value;
                          delete kvMap[k]; if(newKey) kvMap[newKey]=newVal; renderKV();
                      };
                  });
                  kvCont.appendChild(row);
              });
          }
          renderKV();
      }
  
      // Ï†ÄÏû• Ï≤òÎ¶¨
      document.getElementById("saveBtn").onclick=()=>{
            var val;
            if (currentEdit.type === "toggle") val = document.getElementById("modalInput").checked ? "yes":"no";
            else if (currentEdit.type === "keyvalue") val = JSON.stringify(kvMap);
            else val = document.getElementById("modalInput").value;
              
          fetch("/v1/management/config/" + currentEdit.key,{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({value:val})})
              .then(res=> {
                  res.json()
              })
              .then(data => { 
                  document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent=data.value;
                  editModal.hide();
              })
              .catch(err=>alert('Ï†ÄÏû• Ïã§Ìå®: '+err));
  
       // fetch('/api/config/set',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:currentEdit.key,value:val})})
      //	.then(res=>res.json())
      //	.then(data=>{ document.querySelector(`.current-value[data-key="${currentEdit.key}"]`).textContent=data.value; editModal.hide(); })
      //	.catch(err=>alert('Ï†ÄÏû• Ïã§Ìå®: '+err));
      };
  
      // ÌÉ≠ & Í≤ÄÏÉâ Ïù¥Î≤§Ìä∏
      document.querySelectorAll("#categoryTabs .nav-link")
            .forEach(tab=>tab.onclick=e=>{
              e.preventDefault();
              document.querySelectorAll("#categoryTabs .nav-link").forEach(t=>t.classList.remove("active")); 
              tab.classList.add("active"); 
              renderTable(tab.dataset.cat,document.getElementById("searchInput").value);
        });
  
      document.getElementById("searchInput").oninput=()=>{
          var cat=document.querySelector("#categoryTabs .nav-link.active").dataset.cat;
          renderTable(cat,document.getElementById("searchInput").value);
      };
  
      document.getElementById("resetBtn").onclick=()=>{
          document.getElementById("searchInput").value="";
          renderTable();
      };
  
      // Ï°∞Ìöå
      function getList(){
          fetch("/v1/redis/stats")
              .then(res=> { 
                  return res.json();
              })
              .then(data=> {
                  allItems = convertToConfigKeys(data[0].redisInfoList["sum"]);
                  allItems = allItems.filter(i => (i.cat === 'Memory' && i.key === "maxmemory") 
                      || (i.cat === 'Memory' && i.key === "maxmemoryPolicy")
                      || (i.cat === 'Clients' && i.key === "maxclients")
                      || (i.cat === 'Persistence' && i.key === "aofEnabled")
                  )
                  configKeys = allItems; 
                  renderTable('All');
              })
              .catch(err=>alert("Ï†ÄÏû• Ïã§Ìå®: " + err));
      }
  
      function convertToConfigKeys(data){
          var result = [];
          var sections = data;
  
          for (var [cat, values] of Object.entries(sections)){
              for (var [key, val] of Object.entries(values)) {
                    result.push({
                      key: key,
                      cat: capitaliz(cat),
                      desc: "-",
                      type: inputType(key),
                      options: inputOption(key),
                      val: values[key]
                    });
              }
            }
            return result;
      }
      
      function capitaliz(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
      }
  
      function inputType(str){
          var optionType = "";
          switch(str) {
              case 'maxmemoryPolicy':
                  optionType = "dropdown";
                   break;
              default:
                  optionType = 'text';
          }
          return optionType;
      }
  
      function inputOption(str){
          var optionValue = "";
          switch(str) {
              case "maxmemoryPolicy":
                  optionValue = ["noeviction","allkeys-lru","volatile-lru","volatile-random"];
                   break;
              default:
                  optionValue = "";
          }
          return optionValue;
      }
  
      // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
      getList();
      //renderTable();
  </script>
  
          
          