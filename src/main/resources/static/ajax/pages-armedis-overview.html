<div class="page-content">
    <div class="container-fluid">
        <!-- start page title -->
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                    <h4 class="mb-sm-0">Sitemap</h4>

                    <div class="page-title-right">
                        <ol class="breadcrumb m-0">
                            <li class="breadcrumb-item"><a href="javascript: void(0);">Armedis</a></li>
                            <li class="breadcrumb-item active">Overview</li>
                        </ol>
                    </div>

                </div>
            </div>
        </div>
        <!-- end page title -->

        <div class="row">
            <div class="col-xxl-2">
                <div class="d-flex flex-column h-100">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card card-animate" id="opsPerSecCard">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1"></h4>
                                </div><!-- end card header -->
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <!-- <p class="fw-medium text-muted mb-0">Ops/sec</p> -->
                                            <h2 class="mt-4 ff-secondary fw-semibold">
                                                <span class="data-value"></span> ops
                                            </h2>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div> <!-- end card-->
                        </div> <!-- end col-->
                    </div> <!-- end row-->

                    <div class="row">
                        <div class="col-md-12">
                            <div class="card card-animate" id="connectedClientsCard">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1"></h4>
                                </div><!-- end card header -->
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <!-- <p class="fw-medium text-muted mb-0">Connected Clients</p> -->
                                            <h2 class="mt-4 ff-secondary fw-semibold">
                                                <span class="data-value"></span>
                                            </h2>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div> <!-- end card-->
                        </div> <!-- end col-->
                    </div> <!-- end row-->
                </div>
            </div> <!-- end col-->

            <div class="col-xxl-8">
                <div class="row h-100">
                    <div class="col-xl-6">
                        <div class="card card-animate card-height-100" id="networkCard">
                            <div class="card-header align-items-center d-flex">
                                <h4 class="card-title mb-0 flex-grow-1"></h4>
                            </div><!-- end card header -->

                            <!-- card body -->
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="fw-medium text-muted mb-0">Input</p>
                                        <div id="inputRadialbar" data-colors='["--vz-primary", "--vz-warning", "--vz-danger"]' class="apex-charts"
                                            dir="ltr"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="fw-medium text-muted mb-0">Output</p>
                                        <div id="outputRadialbar" data-colors='["--vz-primary", "--vz-warning", "--vz-danger"]' class="apex-charts"
                                            dir="ltr"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- end card body -->
                        </div><!-- end card -->
                    </div><!-- end col -->

                    <div class="col-xl-6">
                        <div class="card card-animate card-height-100" id="memoryCard">
                            <div class="card-header align-items-center d-flex">
                                <h4 class="card-title mb-0 flex-grow-1"></h4>
                            </div>
                            <div class="card-body p-0">
                                <div class="alert alert-danger rounded-top alert-solid alert-label-icon border-0 rounded-0 m-0 d-flex align-items-center d-none"
                                    role="alert">
                                    <i class="ri-error-warning-line label-icon"></i>
                                    <div class="flex-grow-1 text-truncate" id="alertMsg"></div>
                                </div>
                                <div id="memoryBar" data-colors='["--vz-primary"]' class="apex-charts"
                                            dir="ltr"></div>
                            </div><!-- end card body -->
                        </div><!-- end card -->
                    </div> <!-- end col-->
                </div> <!-- end row-->
            </div><!-- end col -->

            <div class="col-xxl-2">
                <div class="d-flex flex-column h-100">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card card-animate" id="uptimeCard">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1"></h4>
                                </div><!-- end card header -->
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <!-- <p class="fw-medium text-muted mb-0">Uptime</p> -->
                                            <h2 class="mt-4 ff-secondary fw-semibold">
                                                <span class="data-value"></span>
                                            </h2>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div> <!-- end card-->
                        </div> <!-- end col-->
                    </div> <!-- end row-->

                    <div class="row">
                        <div class="col-md-12">
                            <div class="card card-animate" id="versionCard">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1"></h4>
                                </div><!-- end card header -->
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <!-- <p class="fw-medium text-muted mb-0">Version</p> -->
                                            <h2 class="mt-4 ff-secondary fw-semibold">
                                                <span class="data-value"></span>
                                            </h2>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div> <!-- end card-->
                        </div> <!-- end col-->
                    </div> <!-- end row-->
                </div>
            </div> <!-- end col-->
        </div> <!-- end row-->

        <div class="row">
            <div class="col-xxl-2">
                <div class="d-flex flex-column h-100">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card card-animate" id="totalKeysCard">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1"></h4>
                                </div><!-- end card header -->
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <!-- <p class="fw-medium text-muted mb-0">Number of Keys</p> -->
                                            <h2 class="mt-4 ff-secondary fw-semibold">
                                                <span class="data-value"></span>
                                            </h2>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div> <!-- end card-->
                        </div> <!-- end col-->
                    </div> <!-- end row-->
                </div>
            </div> <!-- end col-->

            <div class="col-xxl-8">
                <div class="row h-100">
                    <div class="col-xl-6">
                        <div class="card card-animate card-height-100" id="keyspaceCard">
                            <div class="card-header align-items-center d-flex">
                                <h4 class="card-title mb-0 flex-grow-1"></h4>
                            </div><!-- end card header -->

                            <!-- card body -->
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h6 class="mb-0"></h6>
                                    <span class="small-muted"></span>
                                </div>
                                <div class="mb-2">
                                    <div class="mt-2 ks-bar">
                                        <div id="nonTtl" class="ks-fill"
                                            style="width:0%; background:linear-gradient(90deg,#0ab39c)"
                                            data-colors='["--vz-warning", "--vz-success"]'></div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small-muted">
                                    <div>TTL: <strong id="ttlCount"></strong></div>
                                    <div>Non TTL: <strong id="nonTtlCount"></strong></div>
                                </div>
                            </div>
                            <!-- end card body -->
                        </div><!-- end card -->
                    </div><!-- end col -->

                    <div class="col-xl-6">
                        <div class="card card-animate card-height-100" id="hitRateCard">
                            <div class="card-header align-items-center d-flex">
                                <h4 class="card-title mb-0 flex-grow-1"></h4>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h6 class="mb-0"></h6>
                                    <span class="small-muted"></span>
                                </div>
                                <div class="mb-2">
                                    <div class="mt-2 ks-bar">
                                        <div id="ksHits" class="ks-fill"
                                        style="width:0%; background:linear-gradient(90deg,#0ab39c)"
                                            data-colors='["--vz-warning", "--vz-success"]'></div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small-muted">
                                    <div>Hits: <strong id="hitsCount"></strong></div>
                                    <div>Misses: <strong id="missesCount"></strong></div>
                                </div>
                            </div><!-- end card body -->
                        </div><!-- end card -->
                    </div> <!-- end col-->

                </div> <!-- end row-->
            </div><!-- end col -->

            <div class="col-xxl-2">
                <div class="d-flex flex-column h-100">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card card-animate" id="evictionPolicyCard">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1"></h4>
                                </div><!-- end card header -->
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <!-- <p class="fw-medium text-muted mb-0">Eviction Policy</p> -->
                                            <h2 class="mt-4 ff-secondary fw-semibold">
                                                <span class="data-value"></span>
                                            </h2>
                                        </div>
                                    </div>
                                </div><!-- end card body -->
                            </div> <!-- end card-->
                        </div> <!-- end col-->
                    </div> <!-- end row-->
                </div>
            </div> <!-- end col-->
        </div> <!-- end row-->

        <div class="row">
            <div class="col-xl-3">
                <div class="card card-animate" id="clientConnectionsCard">
                    <div class="card-header">
                        <h4 class="card-title mb-0"></h4>
                    </div><!-- end card header -->

                    <div class="card-body">
                        <table class="table table-bordered dt-responsive nowrap table-striped align-middle"
                            style="width:100%">
                            <thead>
                                <tr></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div><!-- end card-body -->
                </div><!-- end card -->
            </div> <!-- end col -->

            <div class="col-xl-3">
                <div class="card card-animate" id="commandStatisticsCard">
                    <div class="card-header">
                        <h4 class="card-title mb-0"></h4>
                    </div><!-- end card header -->

                    <div class="card-body">
                        <table class="table table-bordered dt-responsive nowrap table-striped align-middle"
                            style="width:100%">
                            <thead>
                                <tr></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div><!-- end card-body -->
                </div><!-- end card -->
            </div> <!-- end col -->

            <div class="col-xl-6">
                <div class="card card-animate" id="slowQueriesLogCard">
                    <div class="card-header">
                        <h4 class="card-title mb-0"></h4>
                    </div><!-- end card header -->

                    <div class="card-body">
                        <table class="table table-bordered dt-responsive nowrap table-striped align-middle"
                            style="width:100%">
                            <thead>
                                <tr></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div><!-- end card-body -->
                </div><!-- end card -->
            </div> <!-- end col -->
        </div> <!-- end row-->

        <div class="row">
            <div class="col-xl-12">
                <div class="card card-animate" id="nodesCard">
                    <div class="card-header">
                        <h4 class="card-title mb-0"></h4>
                    </div><!-- end card header -->

                    <div class="card-body">
                        <table class="table table-bordered dt-responsive nowrap table-striped align-middle"
                            style="width:100%">
                            <thead>
                                <tr></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div><!-- end card-body -->
                </div><!-- end card -->
            </div> <!-- end col -->
        </div> <!-- end row-->
    </div>
    <!-- container-fluid -->
</div>
<!-- End Page-content -->

<!-- Date library -->
<script src="/assets/libs/moment/moment.js"></script>

<!-- apexcharts -->
<script src="/assets/libs/apexcharts/apexcharts.min.js"></script>

<!-- areacharts init -->
<script src="/assets/js/pages/apexcharts-radialbar.init.js"></script>

<script src="/assets/js/common.js"></script>

<script>
    var intervalId = undefined;
    var charts = {};
    var statsData = [];
    
    var networkInputSeries = {
        data: [0]
    };
    var networkOutputSeries = {
        data: [0]
    };
    var memorySeries = {
        series: [{
            data: [0, 0, 0, 0, 0]
        }],
        categories: ["Used Memory", "Used Memory, Peak", "Used Memory, LUA", "Memory Limit", "Total System Memory"]
    };
    var keysSeries = {
        series: [{
            data: [0]
        }]
    };
    var tables = [
        { 
            id: "clientConnectionsCard", 
            headers: [
                { name: "client", title: "Client", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                { name: "totalDuration", title: "Total Duration", style: { headerTextAlign: "center", cellTextAlign: "right", width: "20%" } },
                { name: "idleTime", title: "Idle time", style: { headerTextAlign: "center", cellTextAlign: "right", width: "20%" } },
                { name: "lastCommand", title: "Last command", style: { headerTextAlign: "center", cellTextAlign: "left", width: "*" } }
            ] 
        },
        { 
                id: "commandStatisticsCard", 
                headers: [
                    { name: "command", title: "Command", style: { headerTextAlign: "center", cellTextAlign: "center", width: "*" } },
                    { name: "numberOfCalls", title: "Number of calls", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                    { name: "totalDuration", title: "Total Duration", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                    { name: "durationPerCall", title: "Duration per call", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } }
                ] 
        },
        { 
                id: "slowQueriesLogCard", 
                headers: [
                    { name: "timestamp", title: "Timestamp", style: { headerTextAlign: "center", cellTextAlign: "left", width: "25%" } },
                    { name: "duration", title: "Duration", style: { headerTextAlign: "center", cellTextAlign: "right", width: "25%" } },
                    { name: "command", title: "Command", style: { headerTextAlign: "center", cellTextAlign: "left", width: "*" } }
                ] 
        },
        { 
                id: "nodesCard", 
                headers: [
                    { name: "id", title: "Id", style: { headerTextAlign: "center", cellTextAlign: "", width: "20%" } },
                    { name: "address", title: "Address", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                    { name: "flags", title: "Flags", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                    { name: "replicaMaster", title: "Replica's Master", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                    { name: "pingWasSent", title: "Ping was sent", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                    { name: "pongWasReceived", title: "Pong was received", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                    { name: "state", title: "State", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } },
                    { name: "hashSlotNumberOrRange", title: "Hash slot number or range", style: { headerTextAlign: "center", cellTextAlign: "center", width: "20%" } }
                ] 
        }
    ];

    // 차트 영역 생성
    function createChartCard(cardId, cardBodyTarget, chartType, series) {
        var parent = document.getElementById(cardId);
        var chartElement = parent.querySelector("#" + cardBodyTarget);
        
        // 차트
        var chartOptions = {}
        if (chartType === "guage") {
            chartOptions = {
                series,
                chart: {
                    type: "radialBar",
                    height: 250,
                    offsetY: 10,
                    sparkline: {
                        enabled: true
                    },
                    animations: {
                        enabled: true,
                        easing: "linear",
                        speed: 300
                    }
                },
                plotOptions: {
                    radialBar: {
                        startAngle: -90,
                        endAngle: 90,
                        track: {
                            background: "#e7e7e7",
                            strokeWidth: "97%",
                            margin: 5, // margin is in pixels
                            dropShadow: {
                                enabled: true,
                                top: 2,
                                left: 0,
                                color: "#999",
                                opacity: 1,
                                blur: 2
                            }
                        },
                        dataLabels: {
                            name: {
                                show: false
                            },
                            value: {
                                show: true,
                                offsetY: -2,
                                fontSize: "22px",
                                formatter: function (val, opts) {
                                    var originValue = opts.config.custom ? opts.config.custom.origin : 0;
                                    return getMemoryCapacityUnit(originValue) + "/s" ;
                                }
                            }
                        }
                    }
                },
                grid: {
                    padding: {
                        top: -10
                    }
                }
            };
        } else {
            // bar chart
            chartOptions = {
                chart: {
                    height: 250,
                    type: "bar",
                    toolbar: {
                        show: false,
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                    }
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        colors: ["#000000"]
                    },
                    formatter: function (val) {
                        return getMemoryCapacityUnit(val);
                    }
                },
                series: series.series,
                colors: getChartColorsArray(cardBodyTarget),
                grid: {
                    borderColor: "#f1f1f1",
                },
                xaxis: {
                    categories: series.categories,
                    labels: {
                        formatter: function (val) {
                            return getMemoryCapacityUnit(val);
                        }
                    },
                    tickAmount: 3
                }
            }
        }

        var chart = new ApexCharts(chartElement, chartOptions);
        chart.render();
        charts[cardBodyTarget] = chart;
    }

    // card box 설정
    function initCard() {
        var cards = [
            { id: "opsPerSecCard", title: "Ops/sec" },
            { id: "connectedClientsCard", title: "Connected Clients" },
            { id: "networkCard", title: "Network" },
            { id: "memoryCard", title: "Memory" },
            { id: "uptimeCard", title: "Uptime" },
            { id: "versionCard", title: "Version" },
            { id: "totalKeysCard", title: "Total Keys" },
            { id: "keyspaceCard", title: "Keyspace" },
            { id: "hitRateCard", title: "Average Hit Rate" },
            { id: "evictionPolicyCard", title: "Eviction Policy" },
            { id: "clientConnectionsCard", title: "Client connections" },
            { id: "commandStatisticsCard", title: "Command statistics" },
            { id: "slowQueriesLogCard", title: "Slow queries log" },
            { id: "nodesCard", title: "Nodes" }
        ];

        cards.forEach(elem => {
            var parent = document.getElementById(elem.id);
            var cardHeaderElement = parent.querySelector(".card-header .card-title");

            // 차트 제목
            cardHeaderElement.innerText = elem.title;
        })
    }

    function initChart() {
        createChartCard("networkCard", "inputRadialbar", "guage", networkInputSeries.data);
        createChartCard("networkCard", "outputRadialbar", "guage", networkOutputSeries.data);
        createChartCard("memoryCard", "memoryBar", "bar", memorySeries);
    }

    function setDataValue(cardId, value) {
        var parent = document.getElementById(cardId);
        if (parent) {
            parent.querySelector(".data-value").innerText = value;
        }
    }

    // Ops/Sec 설정
    function setOpsPerSec() {
        var cardId = "opsPerSecCard";
        var lastStatsSumStats = _.last(statsData).redisInfoList.sum.stats;
        setDataValue(cardId, lastStatsSumStats.instantaneousOpsPerSec);
    }

    // Connected Clients 설정
    function setConnectedClients() {
        var cardId = "connectedClientsCard";
        var lastStatsSumClients = _.last(statsData).redisInfoList.sum.clients;
        setDataValue(cardId, lastStatsSumClients.connectedClients.toLocaleString());
    }

    // Number of Keys 설정
    function setTotalKeys() {
        var cardId = "totalKeysCard";
        var lastStatsSumKeyspace = _.last(statsData).redisInfoList.sum.keyspace;
        setDataValue(cardId, lastStatsSumKeyspace['0'].keys.toLocaleString());
    }

    // Network 설정
    function setNetwork() {
        var cardId = "networkCard";
        var lastStatsSumStats = _.last(statsData).redisInfoList.sum.stats;
        
        // total 10GB 기준
        var total =  10 * (1024 * 1024 * 1024);
        var inputPct = Math.round((lastStatsSumStats.totalNetInputBytes / total) * 100);
        var outputPct = Math.round((lastStatsSumStats.totalNetOutputBytes / total) * 100);
        
        var limit = (num, max = 100) => Math.min(num, max);
        networkInputSeries.data[0] = limit(inputPct);
        networkOutputSeries.data[0] = limit(outputPct);
        
        var parent = document.getElementById(cardId);
        if (parent) {
            var inputChartElement = parent.querySelector("#inputRadialbar");
            var outputChartElement = parent.querySelector("#outputRadialbar");
    
            charts["inputRadialbar"].updateOptions({
                custom: {
                    origin: lastStatsSumStats.totalNetInputBytes
                },
                colors: [getChartColors("inputRadialbar", inputPct)]
            }, true, true);
            charts["outputRadialbar"].updateOptions({
                custom: {
                    origin: lastStatsSumStats.totalNetOutputBytes
                },
                colors: [getChartColors("outputRadialbar", outputPct)]
            }, true, true);
            charts["inputRadialbar"].updateSeries(networkInputSeries.data, true);
            charts["outputRadialbar"].updateSeries(networkOutputSeries.data, true);
        }
    }

    // Memory 설정
    function setMemory() {
        var cardId = "memoryCard";
        var parent = document.getElementById(cardId);
        if (parent) {
            var memoryElement = parent.querySelector("#memoryBar");
            var lastStatsSumMemory = _.last(statsData).redisInfoList.sum.memory;
    
            // Max Memory가 없는 경우 Card에 Alert표시
            if (lastStatsSumMemory.maxmemory > 0) {
                parent.querySelector(".alert").classList.add("d-none");
            } else {
                parent.querySelector(".alert > #alertMsg").innerText = "Memory Limit 설정이 필요합니다.";
                parent.querySelector(".alert").classList.remove("d-none");
            }
            
            series: [{
                data: [0, 0, 0, 0, 0]
            }],
    
            charts["memoryBar"].updateOptions({
                xaxis: {
                    max: getMemoryCapacityUnit(lastStatsSumMemory.totalSystemMemory)
                }
            }, true);
            charts["memoryBar"].updateSeries(
                [{
                    data: [
                        lastStatsSumMemory.usedMemory,
                        lastStatsSumMemory.usedMemoryPeak,
                        lastStatsSumMemory.usedMemoryLua,
                        lastStatsSumMemory.maxmemory,
                        lastStatsSumMemory.totalSystemMemory
                    ]
                }]
                , true);
        }
    }

    function setUptime() {
        var cardId = "uptimeCard";
        var lastStatsSumServer = _.last(statsData).redisInfoList.sum.server;
        var duration = moment.duration(lastStatsSumServer.uptimeInSeconds, "seconds");
        setDataValue(cardId, duration.humanize());
    }

    // Keyspace 설정
    function setKeyspace() {
        var lastStatsSumStats = _.last(statsData).redisInfoList.sum.stats;
        var lastStatsSumKeyspace = _.last(statsData).redisInfoList.sum.keyspace;
        var { keys, expires } = lastStatsSumKeyspace[0];
        var nonTTL = keys - expires;
        
        // keyspace Bar 배경색 변경
        var cardBodyTarget = "nonTtl";
        var colors = getChartColorsArray(cardBodyTarget);
        document.getElementById("keyspaceCard").querySelector(".ks-bar").style.backgroundColor = colors[0];

        var total = Math.max(keys, 1);
        var expiredPct = Math.round((expires / total) * 100);
        $("#nonTtl").css("width", Math.max(2, expiredPct) + "%");
        $("#ttlCount").text(expires.toLocaleString());
        $("#nonTtlCount").text(nonTTL.toLocaleString());
    }

    // hitRate 설정
    function setHitRate() {
        var lastStatsSumStats = _.last(statsData).redisInfoList.sum.stats;

        // Hit Rate
        var hits = Number(lastStatsSumStats.keyspaceHits ?? 0);
        var misses = Number(lastStatsSumStats.keyspaceMisses ?? 0);

        // keyspace Bar 배경색 변경
        // var cardBodyTarget = "ksHits";
        // var colors = getChartColorsArray(cardBodyTarget);
        // document.getElementById("hitRateCard").querySelector(".ks-bar").style.backgroundColor = colors[0];

        var total = Math.max(hits + misses, 1);
        var hitRate = Math.round((hits / total) * 100);
        if (Number.isNaN(hitRate)) {
            hitRate = 0;
        }

        $("#ksHits").css("width", Math.max(2, hitRate) + "%");
        $("#hitsCount").text(getMemoryCapacityUnit(hits));
        $("#missesCount").text(getMemoryCapacityUnit(misses));
    }

    // Version 설정
    function setVersion() {
        var cardId = "versionCard";
        var lastStatsSumServer = _.last(statsData).redisInfoList.sum.server;
        setDataValue(cardId, lastStatsSumServer.redisVersion);
    }

    // Eviction Policy 설정
    function setEvictionPolicy() {
        var cardId = "evictionPolicyCard";
        var lastStatsSumMemory = _.last(statsData).redisInfoList.sum.memory;
        setDataValue(cardId, lastStatsSumMemory.maxmemoryPolicy);
    }

    // Redis 정보 조회
    async function getStats() {
        var response = await fetch("/v1/redis/stats");
        if (!response.ok) throw new Error("HTTP " + res.status);

        var data = await response.json();
        statsData = data;

        setOpsPerSec();
        setConnectedClients();
        setTotalKeys();
        setNetwork();
        setMemory();
        setUptime();
        setKeyspace();
        setHitRate();
        setVersion();
        setEvictionPolicy()
    }

    async function getClientConnections() {
        var rowCnt = 20;
        var response = await fetch(`/v1/management/clientlist/${rowCnt}`);
        if (!response.ok) throw new Error("HTTP " + res.status);

        var data = await response.json();
        if (data.result.length > 0) {
            var last20Datas = _.takeRight(data.result, rowCnt);
            last20Datas = _.map(last20Datas, item => {
                var picked = _.pick(item, ['addr', 'age', 'idle', 'cmd']);
                picked.age = `${picked.age} s`;
                picked.idle = `${picked.idle} s`;
                return {
                    client: picked.addr,
                    totalDuration: picked.age,
                    idleTime: picked.idle,
                    lastCommand: picked.cmd
                };
            });
            
            setTableRows(tables[0], last20Datas, rowCnt);
        }
    }

    // Slow queries log 조회
    async function getSlowlog() {
        var rowCnt = 20;
        var response = await fetch(`/v1/management/slowlog/${rowCnt}`);
        if (!response.ok) throw new Error("HTTP " + res.status);

        var data = await response.json();
        if (data.result.length > 0) {
            var slowlogs = _.map(data.result, item => {
                var cloned = _.clone(item);
                var [timestamp, duration, commands] = _.pullAt(cloned, [1, 2, 3]);
                return {
                    timestamp: moment.unix(timestamp).fromNow(),
                    duration: `${duration} μs`,
                    command: _.head(commands)
                }
            });
            
            setTableRows(tables[2], slowlogs, rowCnt);
        }
    }

    // Table 설정
    function createInitTable(cardId, headers) {
        var parent = document.getElementById(cardId);
        var tableTheadTr = parent.querySelector("table thead tr");
        var tableTbody = parent.querySelector("table tbody");
        
        // Table thead 설정
        tableTheadTr.innerHTML = "";
        headers.forEach(elem => {
            var tableTh = document.createElement("th");
            tableTh.style.textAlign = elem.style.headerTextAlign;
            tableTh.innerText = elem.title;
            tableTheadTr.appendChild(tableTh);
        });
        
        // Table tbody 설정
        var tableTbodyTr = document.createElement("tr");
        var tableTd = document.createElement("td");
        tableTd.textContent = "데이터가 없습니다.";
        tableTd.style.textAlign = "center";
        tableTd.colSpan = headers.length;
        tableTbodyTr.appendChild(tableTd);

        tableTbody.innerHTML = "";
        tableTbody.appendChild(tableTbodyTr);
    }

    function setTableRows(tableInfo, datas, rowsCnt = 10) {
        var cloneStatsData = _.cloneDeep(datas);
        var cardId = tableInfo.id ?? undefined;
        var parent = document.getElementById(cardId);
        if (parent) {
            var tableTbody = parent.querySelector("table tbody");
            
            var tableRows = [];
            if (cloneStatsData.length > 0) {
                cloneStatsData.forEach(elem => {
                    tableRows.push(elem)
                    if (tableRows.length > rowsCnt) {
                        tableRows.shift();
                    }
        
                    tableTbody.innerHTML = "";
                    var keys = Object.keys(tableRows[0]);
                    var headerData = tables.find(item => item.id === cardId);
                    tableRows.forEach(elem => {
                        var tableTr = document.createElement("tr");
                        keys.forEach(key => {
                            var headersObj = headerData.headers.find(item => item.name === key);
                            var tableTd = document.createElement("td");
                            tableTd.style.overflowWrap = "anywhere";
                            
                            if (headersObj && key === headersObj.name) {
                                tableTd.style.textAlign = headersObj.style.cellTextAlign;
                                tableTd.style.width = headersObj.style.width;
                            }
                            
                            tableTd.innerText = elem[key] === "NULL" ? "" : elem[key];
                            tableTr.appendChild(tableTd);
                        })
                        tableTbody.appendChild(tableTr);
                    });
                });
            } else {
                var tableTr = document.createElement("tr");
                var tableTd = document.createElement("td");
                tableTd.textContent = "데이터가 없습니다.";
                tableTd.style.textAlign = "center";
                tableTd.colSpan = tableInfo.headers.length;
                tableTr.appendChild(tableTd);
    
                tableTbody.innerHTML = "";
                tableTbody.appendChild(tableTr);
            }
        }
    }

    // Table 초기설정
    function initTable() {
        tables.forEach(elem => {
            createInitTable(elem.id, elem.headers);
        });
    }

    function intervalInit() {
        getStats();
        getClientConnections();
        getSlowlog();
    }

    window.pageHooks = window.pageHooks || {};
    window.pageHooks["pages-armedis-overview.html"] = {
        onLoad: function () {
            initCard();
            initChart();
            initTable();
            intervalInit();
            intervalId = setInterval(() => {
                intervalInit();
            }, 5000);
        },
        onUnload: function () {
            if (intervalId) {
                clearInterval(intervalId);
            }
        }
    };
</script>
<style>
    :root {
        --bg: #f4f7fb;
        --card: #ffffff;
        --muted: #9aa6b2;
        --green: #2ecc71;
        --red: #e74c3c;
        --blue: #2b8cff;
        --panel-border: rgba(0, 0, 0, 0.06);
        --accent: #0d6efd;
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, "Helvetica Neue", Arial;
    }

    body {
        background: var(--bg);
        color: #24313a;
    }

    .card {
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        background: var(--card);
        box-shadow: 0 6px 16px rgba(20, 30, 40, 0.04);
    }

    .top-stat {
        padding: 18px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
    }

    .stat-value {
        font-weight: 800;
        font-size: 28px;
        line-height: 1;
    }

    .stat-label {
        font-size: 12px;
        color: var(--muted);
        margin-top: 6px;
        text-transform: uppercase;
        letter-spacing: .06em;
    }

    /* grid like screenshot */
    .grid-4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 12px;
    }

    .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 12px;
    }

    .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 12px;
    }

    .gauge-large {
        height: 150px;
    }

    .sparkbars {
        height: 56px;
    }

    /* small badges style */
    .badge-panel {
        padding: 10px 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .badge-value {
        font-size: 20px;
        font-weight: 700;
    }

    .badge-sub {
        font-size: 12px;
        color: var(--muted);
        margin-top: 4px;
    }

    /* small tables */
    .table-sm td,
    .table-sm th {
        padding: 6px 8px;
        vertical-align: middle;
    }

    .small-muted {
        font-size: 12px;
        color: var(--muted);
    }

    /* keyspace bar */
    .ks-bar {
        height: 12px;
        border-radius: 6px;
        background: #f1f6f0;
        overflow: hidden;
        display: flex;
        align-items: center;
    }

    .ks-fill {
        height: 100%;
        background: linear-gradient(90deg, #1abc9c, #16a085);
        display: block;
    }

    /* right side blue boxes */
    .blue-box {
        background: linear-gradient(180deg, #1d6fe0, #0d47a1);
        color: white;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
    }

    .blue-box .big {
        font-weight: 800;
        font-size: 20px;
    }

    /* responsive tweaks */
    @media (max-width: 1000px) {
        .grid-4 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 640px) {

        .grid-4,
        .grid-3,
        .grid-2 {
            grid-template-columns: 1fr;
        }
    }
</style>